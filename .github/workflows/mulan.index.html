<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>木兰从军记</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap');
        
        .chinese-brush {
            font-family: 'Ma Shan Zheng', cursive;
        }
        
        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .animate-fadeIn {
            animation: fadeIn 1s ease-in-out;
        }
        
        .emotion-bar {
            height: 12px;
            transition: width 0.5s ease;
        }
        
        /* 填空样式 */
        .blank {
            display: inline-block;
            width: 80px;
            border-bottom: 1px solid #8b4513;
            text-align: center;
            margin: 0 4px;
        }
        
        /* 确保按钮可点击 */
        button {
            cursor: pointer;
            position: relative;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans min-h-screen">
    <!-- 检测暗色模式 -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <div id="game-container" class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- 开始屏幕 -->
        <div id="start-screen" class="text-center">
            <h1 class="text-4xl md:text-6xl mb-8 chinese-brush text-amber-800 dark:text-amber-500">木兰从军记</h1>
            <div class="bg-amber-50 dark:bg-gray-800 rounded-lg p-6 md:p-10 shadow-lg mb-8">
                <p class="mb-4 text-lg">南北朝时期，木兰女扮男装，替父从军，历经战场磨砺，最终荣归故里。本游戏让你体验木兰的心路历程，探索她内心的情感世界。</p>
                <p class="italic text-sm mb-6">通过本游戏，你将思考IB核心概念：时间与空间、社会公平、自我认同与性别等议题。</p>
                <div class="flex flex-col md:flex-row justify-center gap-4 mb-6">
                    <div class="flex-1 border border-amber-700 dark:border-amber-500 rounded-lg p-4">
                        <h3 class="text-xl font-bold mb-2">教育目标</h3>
                        <ul class="text-left list-disc pl-5">
                            <li>理解《木兰诗》的文本含义</li>
                            <li>了解南北朝时期历史背景</li>
                            <li>探索木兰的情感与心理</li>
                        </ul>
                    </div>
                    <div class="flex-1 border border-amber-700 dark:border-amber-500 rounded-lg p-4">
                        <h3 class="text-xl font-bold mb-2">游戏模式</h3>
                        <ul class="text-left list-disc pl-5">
                            <li>填空挑战</li>
                            <li>记忆配对</li>
                            <li>情境互动</li>
                            <li>心理探索</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="mb-6">
                <h2 class="text-2xl mb-4 chinese-brush">选择难度</h2>
                <div class="flex justify-center gap-4 flex-wrap">
                    <button id="easy-btn" class="difficulty-btn px-6 py-3 bg-amber-700 text-white rounded-lg hover:bg-amber-600">小卒</button>
                    <button id="medium-btn" class="difficulty-btn px-6 py-3 bg-amber-700 text-white rounded-lg hover:bg-amber-600">百夫长</button>
                    <button id="hard-btn" class="difficulty-btn px-6 py-3 bg-amber-700 text-white rounded-lg hover:bg-amber-600">将军</button>
                </div>
            </div>
            
            <button id="start-btn" class="px-10 py-4 bg-red-800 text-white text-xl rounded-lg hover:bg-red-700">开始旅程</button>
        </div>
        
        <!-- 关卡选择屏幕 -->
        <div id="level-select" class="hidden">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl md:text-4xl chinese-brush text-amber-800 dark:text-amber-500">木兰从军记</h1>
                <div class="flex gap-2">
                    <div class="text-right">
                        <div class="text-sm mb-1">难度: <span id="current-difficulty" class="font-bold">小卒</span></div>
                        <div class="text-sm">进度: <span id="progress-text">0/5</span></div>
                    </div>
                    <button id="home-btn" class="p-2 rounded-full bg-amber-700 text-white hover:bg-amber-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- 关卡卡片 - 所有关卡都可点击 -->
                <div id="level-card-1" class="bg-amber-50 dark:bg-gray-800 rounded-lg p-5 shadow-md cursor-pointer hover:shadow-lg transition-all">
                    <h3 class="text-xl font-bold mb-2">关卡一：闻军令</h3>
                    <p class="text-sm mb-3">北魏与柔然交战，朝廷下达征兵令。</p>
                    <div class="flex justify-between text-xs">
                        <span class="bg-amber-700 text-white px-2 py-1 rounded">简单</span>
                        <span>填空游戏 + 心理活动</span>
                    </div>
                </div>
                
                <div id="level-card-2" class="bg-amber-50 dark:bg-gray-800 rounded-lg p-5 shadow-md cursor-pointer hover:shadow-lg transition-all">
                    <h3 class="text-xl font-bold mb-2">关卡二：替父从军</h3>
                    <p class="text-sm mb-3">木兰决定女扮男装，替年迈的父亲从军。</p>
                    <div class="flex justify-between text-xs">
                        <span class="bg-amber-700 text-white px-2 py-1 rounded">中等</span>
                        <span>情境互动 + 心事箱</span>
                    </div>
                </div>
                
                <div id="level-card-3" class="bg-amber-50 dark:bg-gray-800 rounded-lg p-5 shadow-md cursor-pointer hover:shadow-lg transition-all">
                    <h3 class="text-xl font-bold mb-2">关卡三：军营生存</h3>
                    <p class="text-sm mb-3">木兰进入军营，需要隐藏身份并适应军旅生活。</p>
                    <div class="flex justify-between text-xs">
                        <span class="bg-amber-700 text-white px-2 py-1 rounded">中高难度</span>
                        <span>情境互动 + 填空</span>
                    </div>
                </div>
                
                <div id="level-card-4" class="bg-amber-50 dark:bg-gray-800 rounded-lg p-5 shadow-md cursor-pointer hover:shadow-lg transition-all">
                    <h3 class="text-xl font-bold mb-2">关卡四：沙场点兵</h3>
                    <p class="text-sm mb-3">木兰参与战斗，展现军事才能。</p>
                    <div class="flex justify-between text-xs">
                        <span class="bg-amber-700 text-white px-2 py-1 rounded">困难</span>
                        <span>战略决策 + 记忆配对</span>
                    </div>
                </div>
                
                <div id="level-card-5" class="bg-amber-50 dark:bg-gray-800 rounded-lg p-5 shadow-md cursor-pointer hover:shadow-lg transition-all">
                    <h3 class="text-xl font-bold mb-2">关卡五：功成名就</h3>
                    <p class="text-sm mb-3">木兰立下战功，面临升官与归家的抉择。</p>
                    <div class="flex justify-between text-xs">
                        <span class="bg-amber-700 text-white px-2 py-1 rounded">最高难度</span>
                        <span>综合挑战</span>
                    </div>
                </div>
            </div>
            
            <!-- 情感状态面板 -->
            <div class="bg-amber-50 dark:bg-gray-800 rounded-lg p-4 shadow-md mb-8">
                <h3 class="text-lg font-bold mb-2">木兰情感状态</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span>勇气</span>
                            <span id="courage-value">20%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div id="courage-bar" class="emotion-bar bg-red-500 rounded-full" style="width: 20%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span>思乡</span>
                            <span id="homesick-value">10%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div id="homesick-bar" class="emotion-bar bg-blue-500 rounded-full" style="width: 10%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span>决心</span>
                            <span id="determination-value">30%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div id="determination-bar" class="emotion-bar bg-green-500 rounded-full" style="width: 30%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span>恐惧</span>
                            <span id="fear-value">15%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div id="fear-bar" class="emotion-bar bg-yellow-500 rounded-full" style="width: 15%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 关卡一：闻军令 -->
        <div id="level-1" class="level-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold chinese-brush text-amber-800 dark:text-amber-500">关卡一：闻军令</h2>
                <button class="back-to-map p-2 bg-amber-700 text-white rounded hover:bg-amber-600">
                    返回地图
                </button>
            </div>
            
            <div class="bg-amber-50 dark:bg-gray-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="mb-6">
                    <h3 class="text-xl font-bold mb-3">北魏与柔然交战，朝廷下达征兵令</h3>
                    <p class="mb-4">公元四百年左右，北魏王朝与游牧民族柔然爆发战争。朝廷下达了征兵令，每户人家必须派一名男丁从军。</p>
                    <p class="italic">木兰一家收到了征兵文书，却面临困境：父亲年迈体衰，弟弟年幼，若不从军，家族将蒙受耻辱。</p>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-xl font-bold mb-3">填空游戏：完成木兰诗开篇</h3>
                    <p class="text-sm italic mb-2">请在空白处填入正确的字词，完成《木兰诗》的开篇部分。</p>
                    
                    <div class="fill-blanks-game">
                        <p class="mb-2">
                            <span class="blank" data-answer="唧唧"></span>复<span class="blank" data-answer="唧唧"></span>，木兰当<span class="blank" data-answer="户"></span>织。
                        </p>
                        <p class="mb-2">
                            不闻机杼<span class="blank" data-answer="声"></span>，惟闻女叹<span class="blank" data-answer="息"></span>。
                        </p>
                        <p class="mb-2">
                            问女何所<span class="blank" data-answer="思"></span>，问女何所<span class="blank" data-answer="忆"></span>。
                        </p>
                        <p class="mb-2">
                            女亦无所思，女亦无所<span class="blank" data-answer="忆"></span>。
                        </p>
                        <p class="mb-2">
                            昨夜见<span class="blank" data-answer="军帖"></span>，可汗大点<span class="blank" data-answer="兵"></span>。
                        </p>
                        <p class="mb-2">
                            军书十二卷，卷卷有爷<span class="blank" data-answer="名"></span>。
                        </p>
                    </div>
                    
                    <div class="mt-4 flex flex-wrap gap-2" id="word-bank-1">
                        <button class="word-choice px-3 py-1 bg-amber-200 text-gray-800 rounded hover:bg-amber-300">唧唧</button>
                        <button class="word-choice px-3 py-1 bg-amber-200 text-gray-800 rounded hover:bg-amber-300">声</button>
                        <button class="word-choice px-3 py-1 bg-amber-200 text-gray-800 rounded hover:bg-amber-300">户</button>
                        <button class="word-choice px-3 py-1 bg-amber-200 text-gray-800 rounded hover:bg-amber-300">思</button>
                        <button class="word-choice px-3 py-1 bg-amber-200 text-gray-800 rounded hover:bg-amber-300">忆</button>
                        <button class="word-choice px-3 py-1 bg-amber-200 text-gray-800 rounded hover:bg-amber-300">息</button>
                        <button class="word-choice px-3 py-1 bg-amber-200 text-gray-800 rounded hover:bg-amber-300">军帖</button>
                        <button class="word-choice px-3 py-1 bg-amber-200 text-gray-800 rounded hover:bg-amber-300">家</button>
                        <button class="word-choice px-3 py-1 bg-amber-200 text-gray-800 rounded hover:bg-amber-300">名</button>
                        <button class="word-choice px-3 py-1 bg-amber-200 text-gray-800 rounded hover:bg-amber-300">人</button>
                        <button class="word-choice px-3 py-1 bg-amber-200 text-gray-800 rounded hover:bg-amber-300">叹</button>
                        <button class="word-choice px-3 py-1 bg-amber-200 text-gray-800 rounded hover:bg-amber-300">兵</button>
                    </div>
                    
                    <button id="check-fill-blanks" class="mt-4 px-4 py-2 bg-red-800 text-white rounded hover:bg-red-700">检查答案</button>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-xl font-bold mb-3">心理活动题</h3>
                    <p class="mb-3">面对年迈父亲可能出征，木兰最担忧的是什么？（选择最符合的答案）</p>
                    
                    <div class="space-y-2">
                        <label class="flex items-start p-2 rounded hover:bg-amber-100 dark:hover:bg-gray-700">
                            <input type="radio" name="concern" value="A" class="mt-1 mr-2">
                            <div>
                                <p class="font-bold">A. 父亲的安危</p>
                                <p class="text-sm">担心年迈的父亲无法承受战场上的艰苦环境和激烈战斗</p>
                            </div>
                        </label>
                        <label class="flex items-start p-2 rounded hover:bg-amber-100 dark:hover:bg-gray-700">
                            <input type="radio" name="concern" value="B" class="mt-1 mr-2">
                            <div>
                                <p class="font-bold">B. 家庭的荣誉</p>
                                <p class="text-sm">害怕父亲无法履行兵役义务会让家族蒙羞</p>
                            </div>
                        </label>
                        <label class="flex items-start p-2 rounded hover:bg-amber-100 dark:hover:bg-gray-700">
                            <input type="radio" name="concern" value="C" class="mt-1 mr-2">
                            <div>
                                <p class="font-bold">C. 家庭的生计</p>
                                <p class="text-sm">忧虑失去顶梁柱后家庭将无法维持生计</p>
                            </div>
                        </label>
                        <label class="flex items-start p-2 rounded hover:bg-amber-100 dark:hover:bg-gray-700">
                            <input type="radio" name="concern" value="D" class="mt-1 mr-2">
                            <div>
                                <p class="font-bold">D. 以上都是</p>
                                <p class="text-sm">木兰同时担忧父亲安危、家族荣誉和家庭生计</p>
                            </div>
                        </label>
                    </div>
                    
                    <button id="check-concern" class="mt-4 px-4 py-2 bg-red-800 text-white rounded hover:bg-red-700">提交答案</button>
                </div>
                
                <div id="emotion-diary" class="mb-6 hidden">
                    <h3 class="text-xl font-bold mb-3">情感日记</h3>
                    <p class="mb-3">请完成下面的段落，运用心理描写表达木兰在决定前的内心斗争与情感变化：</p>
                    
                    <textarea id="diary-text" class="w-full p-3 border border-amber-700 rounded h-32 text-base bg-white dark:bg-gray-700" placeholder="我看着父亲苍老的面容，想到他可能要踏上战场，心中不禁..."></textarea>
                    
                    <button id="submit-diary" class="mt-4 px-4 py-2 bg-red-800 text-white rounded hover:bg-red-700">提交日记</button>
                </div>
                
                <div id="level-completion-1" class="hidden">
                    <div class="p-4 border-2 border-green-500 rounded-lg">
                        <h3 class="text-xl font-bold text-green-600 dark:text-green-400 mb-2">关卡完成！</h3>
                        <p>通过这个关卡，你了解了木兰面对征兵令时的内心世界和《木兰诗》的开篇部分。</p>
                        <p class="mt-2 font-bold">IB概念反思：时间与空间</p>
                        <p class="text-sm italic">在南北朝时期，性别角色有严格区分，女性不能参军。这种社会环境下，木兰的选择显得格外勇敢。你认为不同的历史时期会如何影响个人的选择？</p>
                        
                        <div class="mt-4">
                            <p class="font-bold">情感状态变化：</p>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div>勇气 +15%</div>
                                <div>决心 +20%</div>
                            </div>
                        </div>
                        
                        <button class="continue-btn mt-4 px-4 py-2 bg-red-800 text-white rounded hover:bg-red-700">继续游戏</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 关卡二：替父从军 -->
        <div id="level-2" class="level-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold chinese-brush text-amber-800 dark:text-amber-500">关卡二：替父从军</h2>
                <button class="back-to-map p-2 bg-amber-700 text-white rounded hover:bg-amber-600">
                    返回地图
                </button>
            </div>
            
            <div class="bg-amber-50 dark:bg-gray-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="mb-6">
                    <h3 class="text-xl font-bold mb-3">木兰决定女扮男装，替年迈的父亲从军</h3>
                    <p class="mb-3">木兰做出了一个惊人的决定：女扮男装，代替父亲从军。这不仅需要极大的勇气，更需要承担被发现后的严重后果。</p>
                    <p class="italic mb-3">木兰开始了准备工作，购买军装和武器装备。</p>
                    <div class="border-l-4 border-red-800 pl-4 py-2 mb-3 bg-amber-100 dark:bg-gray-700 italic">
                        <p>东市买骏马，西市买鞍鞯，南市买辔头，北市买长鞭。</p>
                    </div>
                </div>
                
                <!-- 1. 木兰心事箱 -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold mb-3">木兰心事箱</h3>
                    <p class="mb-3">木兰决定从军前收拾行囊，以下是她准备带走的物品。请选择三件你认为最能反映她内心状态的物品，并解释每件物品背后的情感含义。</p>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                        <div class="item-card border border-amber-700 rounded-lg p-3 cursor-pointer hover:bg-amber-100 dark:hover:bg-gray-700" data-item="sword">
                            <h4 class="font-bold">父亲的剑 🗡️</h4>
                            <p class="text-sm">父亲年轻时使用的佩剑，有些磨损但保养良好</p>
                        </div>
                        <div class="item-card border border-amber-700 rounded-lg p-3 cursor-pointer hover:bg-amber-100 dark:hover:bg-gray-700" data-item="handkerchief">
                            <h4 class="font-bold">母亲的绣花 🧵</h4>
                            <p class="text-sm">母亲亲手绣的一块手帕，上面有"平安"二字</p>
                        </div>
                        <div class="item-card border border-amber-700 rounded-lg p-3 cursor-pointer hover:bg-amber-100 dark:hover:bg-gray-700" data-item="soil">
                            <h4 class="font-bold">家中泥土 🏡</h4>
                            <p class="text-sm">一小包用布包裹的家门前的泥土</p>
                        </div>
                        <div class="item-card border border-amber-700 rounded-lg p-3 cursor-pointer hover:bg-amber-100 dark:hover:bg-gray-700" data-item="toy">
                            <h4 class="font-bold">儿时玩物 🐴</h4>
                            <p class="text-sm">一个小木马，是木兰儿时最喜欢的玩具</p>
                        </div>
                        <div class="item-card border border-amber-700 rounded-lg p-3 cursor-pointer hover:bg-amber-100 dark:hover:bg-gray-700" data-item="drawing">
                            <h4 class="font-bold">弟弟的画 🖼️</h4>
                            <p class="text-sm">弟弟画的全家人的简笔画</p>
                        </div>
                        <div class="item-card border border-amber-700 rounded-lg p-3 cursor-pointer hover:bg-amber-100 dark:hover:bg-gray-700" data-item="hair">
                            <h4 class="font-bold">剪下的长发 ✂️</h4>
                            <p class="text-sm">木兰剪下的一缕长发，用红绳扎起</p>
                        </div>
                    </div>
                    
                    <div id="selected-items" class="mb-4 hidden">
                        <h4 class="font-bold mb-2">选中的物品：</h4>
                        <div id="item-1" class="mb-3 hidden">
                            <p class="font-bold" id="item-1-name"></p>
                            <textarea class="w-full p-2 border border-amber-700 rounded h-20 text-base bg-white dark:bg-gray-700" placeholder="这件物品对木兰的情感意义是..."></textarea>
                        </div>
                        <div id="item-2" class="mb-3 hidden">
                            <p class="font-bold" id="item-2-name"></p>
                            <textarea class="w-full p-2 border border-amber-700 rounded h-20 text-base bg-white dark:bg-gray-700" placeholder="这件物品对木兰的情感意义是..."></textarea>
                        </div>
                        <div id="item-3" class="mb-3 hidden">
                            <p class="font-bold" id="item-3-name"></p>
                            <textarea class="w-full p-2 border border-amber-700 rounded h-20 text-base bg-white dark:bg-gray-700" placeholder="这件物品对木兰的情感意义是..."></textarea>
                        </div>
                    </div>
                    
                    <button id="submit-items" class="mt-4 px-4 py-2 bg-red-800 text-white rounded hover:bg-red-700 hidden">提交分析</button>
                </div>
                
                <!-- 2. 离别场景选择 -->
                <div id="farewell-scene" class="mb-8 hidden">
                    <h3 class="text-xl font-bold mb-3">离别场景</h3>
                    <p class="mb-3">木兰即将启程从军，她将如何与家人告别？你的选择会影响木兰的情感状态。</p>
                    
                    <div class="space-y-4">
                        <div class="bg-amber-100 dark:bg-gray-700 p-4 rounded-lg">
                            <h4 class="font-bold mb-2">父亲 👴</h4>
                            <p class="mb-3">年迈的父亲既为木兰担忧，又为她的孝心和勇气感到骄傲。</p>
                            <div class="space-y-2">
                                <label class="flex items-start p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                                    <input type="radio" name="farewell-father" value="A" class="mt-1 mr-2">
                                    <div>
                                        <p class="font-bold">A. 郑重承诺</p>
                                        <p class="text-sm">向父亲保证一定平安归来，不辜负他的期望</p>
                                    </div>
                                </label>
                                <label class="flex items-start p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                                    <input type="radio" name="farewell-father" value="B" class="mt-1 mr-2">
                                    <div>
                                        <p class="font-bold">B. 沉默相对</p>
                                        <p class="text-sm">无言中与父亲对视，彼此心意已明</p>
                                    </div>
                                </label>
                                <label class="flex items-start p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                                    <input type="radio" name="farewell-father" value="C" class="mt-1 mr-2">
                                    <div>
                                        <p class="font-bold">C. 跪拜告别</p>
                                        <p class="text-sm">向父亲行大礼，请求他的祝福</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="bg-amber-100 dark:bg-gray-700 p-4 rounded-lg">
                            <h4 class="font-bold mb-2">母亲 👵</h4>
                            <p class="mb-3">木兰的母亲泪眼婆娑，舍不得女儿远行。</p>
                            <div class="space-y-2">
                                <label class="flex items-start p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                                    <input type="radio" name="farewell-mother" value="A" class="mt-1 mr-2">
                                    <div>
                                        <p class="font-bold">A. 抱别安慰</p>
                                        <p class="text-sm">紧紧拥抱母亲，安慰她不要担心</p>
                                    </div>
                                </label>
                                <label class="flex items-start p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                                    <input type="radio" name="farewell-mother" value="B" class="mt-1 mr-2">
                                    <div>
                                        <p class="font-bold">B. 转身离去</p>
                                        <p class="text-sm">不忍看母亲落泪，迅速离开</p>
                                    </div>
                                </label>
                                <label class="flex items-start p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                                    <input type="radio" name="farewell-mother" value="C" class="mt-1 mr-2">
                                    <div>
                                        <p class="font-bold">C. 承诺写信</p>
                                        <p class="text-sm">答应母亲有机会就寄信报平安</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <button id="submit-farewell" class="mt-4 px-4 py-2 bg-red-800 text-white rounded hover:bg-red-700">确认选择</button>
                </div>
                
                <!-- 3. 装备准备挑战 -->
                <div id="equipment-challenge" class="mb-8 hidden">
                    <h3 class="text-xl font-bold mb-3">装备准备挑战</h3>
                    <p class="mb-3">木兰需要在短时间内准备从军所需的装备。请记住以下物品及其购买地点，然后完成测试。</p>
                    
                    <div class="memory-phase mb-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-amber-100 dark:bg-gray-700 p-3 rounded-lg">
                                <h4 class="font-bold flex items-center"><span class="mr-2">🏙️</span> 东市</h4>
                                <p class="ml-6">买骏马 🐎</p>
                            </div>
                            <div class="bg-amber-100 dark:bg-gray-700 p-3 rounded-lg">
                                <h4 class="font-bold flex items-center"><span class="mr-2">🏙️</span> 西市</h4>
                                <p class="ml-6">买鞍鞯 🏇</p>
                            </div>
                            <div class="bg-amber-100 dark:bg-gray-700 p-3 rounded-lg">
                                <h4 class="font-bold flex items-center"><span class="mr-2">🏙️</span> 南市</h4>
                                <p class="ml-6">买辔头 🧶</p>
                            </div>
                            <div class="bg-amber-100 dark:bg-gray-700 p-3 rounded-lg">
                                <h4 class="font-bold flex items-center"><span class="mr-2">🏙️</span> 北市</h4>
                                <p class="ml-6">买长鞭 🔄</p>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4">
                            <p id="memory-timer" class="text-lg font-bold">记忆时间: 10秒</p>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                              <div id="timer-bar" class="bg-red-600 h-2.5 rounded-full" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="quiz-phase" class="hidden">
                        <p class="mb-4">根据记忆，请将以下物品与正确的购买地点匹配：</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <h4 class="font-bold mb-2">物品：</h4>
                                <div class="space-y-2">
                                    <div class="bg-white dark:bg-gray-700 p-2 rounded border border-amber-700 flex items-center">
                                        <span class="mr-2">🐎</span> 骏马
                                    </div>
                                    <div class="bg-white dark:bg-gray-700 p-2 rounded border border-amber-700 flex items-center">
                                        <span class="mr-2">🏇</span> 鞍鞯
                                    </div>
                                    <div class="bg-white dark:bg-gray-700 p-2 rounded border border-amber-700 flex items-center">
                                        <span class="mr-2">🧶</span> 辔头
                                    </div>
                                    <div class="bg-white dark:bg-gray-700 p-2 rounded border border-amber-700 flex items-center">
                                        <span class="mr-2">🔄</span> 长鞭
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="font-bold mb-2">购买地点：</h4>
                                <div class="space-y-2">
                                    <select id="horse-location" class="w-full p-2 rounded border border-amber-700 bg-white dark:bg-gray-700">
                                        <option value="">骏马购买地点...</option>
                                        <option value="east">东市</option>
                                        <option value="west">西市</option>
                                        <option value="south">南市</option>
                                        <option value="north">北市</option>
                                    </select>
                                    <select id="saddle-location" class="w-full p-2 rounded border border-amber-700 bg-white dark:bg-gray-700">
                                        <option value="">鞍鞯购买地点...</option>
                                        <option value="east">东市</option>
                                        <option value="west">西市</option>
                                        <option value="south">南市</option>
                                        <option value="north">北市</option>
                                    </select>
                                    <select id="bridle-location" class="w-full p-2 rounded border border-amber-700 bg-white dark:bg-gray-700">
                                        <option value="">辔头购买地点...</option>
                                        <option value="east">东市</option>
                                        <option value="west">西市</option>
                                        <option value="south">南市</option>
                                        <option value="north">北市</option>
                                    </select>
                                    <select id="whip-location" class="w-full p-2 rounded border border-amber-700 bg-white dark:bg-gray-700">
                                        <option value="">长鞭购买地点...</option>
                                        <option value="east">东市</option>
                                        <option value="west">西市</option>
                                        <option value="south">南市</option>
                                        <option value="north">北市</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <button id="check-equipment" class="px-4 py-2 bg-red-800 text-white rounded hover:bg-red-700">检查答案</button>
                    </div>
                </div>
                
                <!-- 关卡完成信息 -->
                <div id="level-completion-2" class="hidden">
                    <div class="p-4 border-2 border-green-500 rounded-lg">
                        <h3 class="text-xl font-bold text-green-600 dark:text-green-400 mb-2">关卡完成！</h3>
                        <p>通过这个关卡，你探索了木兰决定从军前的内心世界和情感准备。</p>
                        <p class="mt-2 font-bold">IB概念反思：社会公平与自我认同</p>
                        <p class="text-sm italic">木兰不得不隐藏自己的真实身份才能实现保家卫国的愿望。思考在当时的社会环境下，这种身份伪装对木兰的自我认同有何影响？当代社会在性别平等方面有何进步？</p>
                        
                        <div class="mt-4">
                            <p class="font-bold">情感状态变化：</p>
                            <div id="emotion-changes" class="grid grid-cols-2 gap-2 text-sm">
                                <!-- 动态填充 -->
                            </div>
                        </div>
                        
                        <button class="continue-btn mt-4 px-4 py-2 bg-red-800 text-white rounded hover:bg-red-700">继续游戏</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 关卡三：军营生存 -->
        <div id="level-3" class="level-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold chinese-brush text-amber-800 dark:text-amber-500">关卡三：军营生存</h2>
                <button class="back-to-map p-2 bg-amber-700 text-white rounded hover:bg-amber-600">
                    返回地图
                </button>
            </div>
            
            <div class="bg-amber-50 dark:bg-gray-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="mb-6">
                    <h3 class="text-xl font-bold mb-3">木兰进入军营，需要隐藏身份并适应军旅生活</h3>
                    <p class="mb-3">木兰来到军营，必须适应严苛的军旅生活，同时小心隐藏自己的真实身份。这是对她心理和体力的双重考验。</p>
                    <p class="italic mb-3">数年的军旅生活让木兰逐渐成长为一名出色的战士。</p>
                </div>
                
                <!-- 1. 篝火夜话：心灵之镜 -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold mb-3">篝火夜话 🔥</h3>
                    <p class="mb-3">夜晚，士兵们围坐在篝火旁交谈。木兰需要在不暴露身份的前提下参与交流。</p>
                    
                    <div id="campfire-scenarios" class="space-y-6">
                        <!-- 篝火场景1：乡愁之夜 -->
                        <div class="campfire-scene bg-amber-100 dark:bg-gray-700 p-4 rounded-lg border-l-4 border-red-800">
                            <div class="flex mb-3">
                                <span class="text-2xl mr-2">👨‍🦳</span>
                                <div>
                                    <h4 class="font-bold">老兵赵刚</h4>
                                    <p>"十年未归家，不知父母健否。木兰，你思念家乡吗？"</p>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h5 class="font-bold mb-2">你的回应：</h5>
                                <div class="space-y-2">
                                    <label class="flex items-start p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                                        <input type="radio" name="response-homesick" value="A" class="mt-1 mr-2">
                                        <div>
                                            <p class="font-bold">A. "军中即是家，战友如亲人。"</p>
                                            <p class="text-sm text-gray-500">安全但疏远</p>
                                        </div>
                                    </label>
                                    <label class="flex items-start p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                                        <input type="radio" name="response-homesick" value="B" class="mt-1 mr-2">
                                        <div>
                                            <p class="font-bold">B. "家中有老父，确实日夜挂念。"</p>
                                            <p class="text-sm text-gray-500">真实但克制</p>
                                        </div>
                                    </label>
                                    <label class="flex items-start p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                                        <input type="radio" name="response-homesick" value="C" class="mt-1 mr-2">
                                        <div>
                                            <p class="font-bold">C. "男儿志在四方，何须念家。"</p>
                                            <p class="text-sm text-gray-500">符合角色但违心</p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <div id="inner-thoughts-homesick" class="inner-thoughts hidden">
                                <h5 class="font-bold mb-2">木兰内心活动：</h5>
                                <div class="space-y-2">
                                    <!-- 动态填充 -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- 篝火场景2：军中情愫讨论 -->
                        <div id="scene-romance" class="campfire-scene bg-amber-100 dark:bg-gray-700 p-4 rounded-lg border-l-4 border-red-800 hidden">
                            <div class="flex mb-3">
                                <span class="text-2xl mr-2">👦</span>
                                <div>
                                    <h4 class="font-bold">年轻士兵小王</h4>
                                    <p>"兄弟们都说心上有人，木兰独自饮酒，莫非是情伤？"</p>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h5 class="font-bold mb-2">你的回应：</h5>
                                <div class="space-y-2">
                                    <label class="flex items-start p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                                        <input type="radio" name="response-romance" value="A" class="mt-1 mr-2">
                                        <div>
                                            <p class="font-bold">A. "习武之人，无暇儿女情长。"</p>
                                            <p class="text-sm text-gray-500">回避话题</p>
                                        </div>
                                    </label>
                                    <label class="flex items-start p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                                        <input type="radio" name="response-romance" value="B" class="mt-1 mr-2">
                                        <div>
                                            <p class="font-bold">B. "家中有位青梅竹马，只是未敢明言。"</p>
                                            <p class="text-sm text-gray-500">编造故事</p>
                                        </div>
                                    </label>
                                    <label class="flex items-start p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                                        <input type="radio" name="response-romance" value="C" class="mt-1 mr-2">
                                        <div>
                                            <p class="font-bold">C. "笑谈他人风流事，何不说说你自己？"</p>
                                            <p class="text-sm text-gray-500">巧妙转移</p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <div id="inner-thoughts-romance" class="inner-thoughts hidden">
                                <h5 class="font-bold mb-2">木兰内心活动：</h5>
                                <div class="space-y-2">
                                    <!-- 动态填充 -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- 篝火场景3：战争反思 -->
                        <div id="scene-war" class="campfire-scene bg-amber-100 dark:bg-gray-700 p-4 rounded-lg border-l-4 border-red-800 hidden">
                            <div class="flex mb-3">
                                <span class="text-2xl mr-2">🧔</span>
                                <div>
                                    <h4 class="font-bold">中年副官李明</h4>
                                    <p>"今日又埋葬了三位兄弟。说来讽刺，两国相争，死的都是寻常百姓。你们说，战争值得吗？"</p>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h5 class="font-bold mb-2">你的回应：</h5>
                                <div class="space-y-2">
                                    <label class="flex items-start p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                                        <input type="radio" name="response-war" value="A" class="mt-1 mr-2">
                                        <div>
                                            <p class="font-bold">A. "保家卫国，牺牲在所难免。"</p>
                                            <p class="text-sm text-gray-500">传统观点</p>
                                        </div>
                                    </label>
                                    <label class="flex items-start p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                                        <input type="radio" name="response-war" value="B" class="mt-1 mr-2">
                                        <div>
                                            <p class="font-bold">B. "希望这是最后一场战争，让百姓不再受苦。"</p>
                                            <p class="text-sm text-gray-500">和平愿望</p>
                                        </div>
                                    </label>
                                    <label class="flex items-start p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                                        <input type="radio" name="response-war" value="C" class="mt-1 mr-2">
                                        <div>
                                            <p class="font-bold">C. "此处不宜多言，恐影响军心。"</p>
                                            <p class="text-sm text-gray-500">谨慎回避</p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <div id="inner-thoughts-war" class="inner-thoughts hidden">
                                <h5 class="font-bold mb-2">木兰内心活动：</h5>
                                <div class="space-y-2">
                                    <!-- 动态填充 -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button id="submit-campfire" class="mt-4 px-4 py-2 bg-red-800 text-white rounded hover:bg-red-700">继续对话</button>
                </div>
                
                <!-- 2. 骑术练习：军事与文化融合 -->
                <div id="riding-practice" class="mb-8 hidden">
                    <h3 class="text-xl font-bold mb-3">骑术练习 🏇</h3>
                    <p class="mb-3">木兰在训练场进行骑术练习，同时学习军事知识和文化内涵。</p>
                    
                    <div class="bg-amber-100 dark:bg-gray-700 p-4 rounded-lg mb-4">
                        <div class="flex justify-between">
                            <div>
                                <h4 class="font-bold">训练进度</h4>
                                <p class="text-sm">完成下面的知识点收集，提升木兰的骑术水平。</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold">收集：<span id="collected-knowledge">0/5</span></p>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                            <div id="knowledge-progress" class="bg-green-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div id="knowledge-cards" class="space-y-4">
                        <!-- 战术地图解读 -->
                        <div class="knowledge-card bg-white dark:bg-gray-700 p-4 rounded-lg shadow cursor-pointer hover:shadow-md border-l-4 border-amber-700">
                            <div class="flex">
                                <span class="text-2xl mr-3">🗺️</span>
                                <div>
                                    <h4 class="font-bold">战术地图解读</h4>
                                    <p class="text-sm mb-2">通过长城隘口时需保持警惕，这是常见的伏击地点。</p>
                                    <p class="knowledge-content text-sm hidden">北魏与柔然的战争多发生在边塞要地，军队需要熟悉复杂地形。木兰的骑术训练包括在各种地形中保持良好的控制力和判断力。</p>
                                </div>
                            </div>
                            <div class="knowledge-quiz hidden mt-3 border-t pt-3">
                                <p class="font-bold text-sm">问题：在山地隘口遭遇伏击时，最佳的应对策略是？</p>
                                <div class="space-y-1 mt-2">
                                    <label class="flex items-center p-1 rounded hover:bg-amber-100 dark:hover:bg-gray-600">
                                        <input type="radio" name="quiz-tactical" value="A" class="mr-2">
                                        <span class="text-sm">分散突围，各自逃命</span>
                                    </label>
                                    <label class="flex items-center p-1 rounded hover:bg-amber-100 dark:hover:bg-gray-600">
                                        <input type="radio" name="quiz-tactical" value="B" class="mr-2">
                                        <span class="text-sm">集中兵力，冲向最近的出口</span>
                                    </label>
                                    <label class="flex items-center p-1 rounded hover:bg-amber-100 dark:hover:bg-gray-600">
                                        <input type="radio" name="quiz-tactical" value="C" class="mr-2">
                                        <span class="text-sm">占据高地，组织防御</span>
                                    </label>
                                </div>
                                <button class="check-answer mt-2 px-2 py-1 bg-amber-700 text-white text-sm rounded" data-quiz="tactical" data-answer="C">提交答案</button>
                            </div>
                        </div>
                        
                        <!-- 军营生活词汇 -->
                        <div class="knowledge-card bg-white dark:bg-gray-700 p-4 rounded-lg shadow cursor-pointer hover:shadow-md border-l-4 border-amber-700">
                            <div class="flex">
                                <span class="text-2xl mr-3">📝</span>
                                <div>
                                    <h4 class="font-bold">军营生活词汇</h4>
                                    <p class="text-sm mb-2">熟悉与军旅生活相关的专业词汇是融入军营的关键。</p>
                                    <p class="knowledge-content text-sm hidden">鞯(jiān)：马鞍的垫子，骑马必备装备。<br>
                                    辔(pèi)：马嚼子上的绳子，用于控制马匹方向。<br>
                                    柝(tuò)：古代打更用的梆子，军营中用于报时。</p>
                                </div>
                            </div>
                            <div class="knowledge-quiz hidden mt-3 border-t pt-3">
                                <p class="font-bold text-sm">问题："朔气传金柝"中的"柝"是指什么？</p>
                                <div class="space-y-1 mt-2">
                                    <label class="flex items-center p-1 rounded hover:bg-amber-100 dark:hover:bg-gray-600">
                                        <input type="radio" name="quiz-vocab" value="A" class="mr-2">
                                        <span class="text-sm">盔甲上的金属装饰</span>
                                    </label>
                                    <label class="flex items-center p-1 rounded hover:bg-amber-100 dark:hover:bg-gray-600">
                                        <input type="radio" name="quiz-vocab" value="B" class="mr-2">
                                        <span class="text-sm">打更用的梆子</span>
                                    </label>
                                    <label class="flex items-center p-1 rounded hover:bg-amber-100 dark:hover:bg-gray-600">
                                        <input type="radio" name="quiz-vocab" value="C" class="mr-2">
                                        <span class="text-sm">军令传递的信物</span>
                                    </label>
                                </div>
                                <button class="check-answer mt-2 px-2 py-1 bg-amber-700 text-white text-sm rounded" data-quiz="vocab" data-answer="B">提交答案</button>
                            </div>
                        </div>
                        
                        <!-- 古代兵器知识 -->
                        <div class="knowledge-card bg-white dark:bg-gray-700 p-4 rounded-lg shadow cursor-pointer hover:shadow-md border-l-4 border-amber-700">
                            <div class="flex">
                                <span class="text-2xl mr-3">🏹</span>
                                <div>
                                    <h4 class="font-bold">古代兵器知识</h4>
                                    <p class="text-sm mb-2">掌握各类兵器的特点和使用方法是木兰成为出色战士的基础。</p>
                                    <p class="knowledge-content text-sm hidden">北魏时期使用的复合弓，最远射程可达300步，木兰在《木兰诗》中即展现了出色的箭术。骑射是游牧民族的特长，木兰需要掌握这项技能才能在战场上立足。</p>
                                </div>
                            </div>
                            <div class="knowledge-quiz hidden mt-3 border-t pt-3">
                                <p class="font-bold text-sm">问题：北方骑兵最常用的主要武器是？</p>
                                <div class="space-y-1 mt-2">
                                    <label class="flex items-center p-1 rounded hover:bg-amber-100 dark:hover:bg-gray-600">
                                        <input type="radio" name="quiz-weapon" value="A" class="mr-2">
                                        <span class="text-sm">长枪</span>
                                    </label>
                                    <label class="flex items-center p-1 rounded hover:bg-amber-100 dark:hover:bg-gray-600">
                                        <input type="radio" name="quiz-weapon" value="B" class="mr-2">
                                        <span class="text-sm">复合弓</span>
                                    </label>
                                    <label class="flex items-center p-1 rounded hover:bg-amber-100 dark:hover:bg-gray-600">
                                        <input type="radio" name="quiz-weapon" value="C" class="mr-2">
                                        <span class="text-sm">长刀</span>
                                    </label>
                                </div>
                                <button class="check-answer mt-2 px-2 py-1 bg-amber-700 text-white text-sm rounded" data-quiz="weapon" data-answer="B">提交答案</button>
                            </div>
                        </div>
                        
                        <!-- 南北朝历史 -->
                        <div class="knowledge-card bg-white dark:bg-gray-700 p-4 rounded-lg shadow cursor-pointer hover:shadow-md border-l-4 border-amber-700">
                            <div class="flex">
                                <span class="text-2xl mr-3">📜</span>
                                <div>
                                    <h4 class="font-bold">南北朝历史</h4>
                                    <p class="text-sm mb-2">了解南北朝时期的历史背景，有助于理解木兰所处的时代环境。</p>
                                    <p class="knowledge-content text-sm hidden">南北朝时期，北方以游牧民族建立的政权为主，汉族文化与少数民族文化相互交融。边塞文学兴盛，《木兰诗》作为其代表作，真实反映了边塞军民的生活和情感。</p>
                                </div>
                            </div>
                            <div class="knowledge-quiz hidden mt-3 border-t pt-3">
                                <p class="font-bold text-sm">问题：《木兰诗》创作的背景时代是？</p>
                                <div class="space-y-1 mt-2">
                                    <label class="flex items-center p-1 rounded hover:bg-amber-100 dark:hover:bg-gray-600">
                                        <input type="radio" name="quiz-history" value="A" class="mr-2">
                                        <span class="text-sm">汉朝</span>
                                    </label>
                                    <label class="flex items-center p-1 rounded hover:bg-amber-100 dark:hover:bg-gray-600">
                                        <input type="radio" name="quiz-history" value="B" class="mr-2">
                                        <span class="text-sm">唐朝</span>
                                    </label>
                                    <label class="flex items-center p-1 rounded hover:bg-amber-100 dark:hover:bg-gray-600">
                                        <input type="radio" name="quiz-history" value="C" class="mr-2">
                                        <span class="text-sm">南北朝</span>
                                    </label>
                                </div>
                                <button class="check-answer mt-2 px-2 py-1 bg-amber-700 text-white text-sm rounded" data-quiz="history" data-answer="C">提交答案</button>
                            </div>
                        </div>
                        
                        <!-- 诗句意境 -->
                        <div class="knowledge-card bg-white dark:bg-gray-700 p-4 rounded-lg shadow cursor-pointer hover:shadow-md border-l-4 border-amber-700">
                            <div class="flex">
                                <span class="text-2xl mr-3">🌙</span>
                                <div>
                                    <h4 class="font-bold">诗句意境</h4>
                                    <p class="text-sm mb-2">体验《木兰诗》中描述的场景，深入理解诗句含义。</p>
                                    <p class="knowledge-content text-sm hidden">"朔气传金柝，寒光照铁衣"描绘了北方边塞严寒的环境和森严的军营氛围。木兰在这样艰苦的环境中坚持十二年，展现了非凡的毅力和勇气。</p>
                                </div>
                            </div>
                            <div class="knowledge-quiz hidden mt-3 border-t pt-3">
                                <p class="font-bold text-sm">问题："万里赴戎机，关山度若飞"表达了什么？</p>
                                <div class="space-y-1 mt-2">
                                    <label class="flex items-center p-1 rounded hover:bg-amber-100 dark:hover:bg-gray-600">
                                        <input type="radio" name="quiz-poetry" value="A" class="mr-2">
                                        <span class="text-sm">木兰骑术精湛，行进迅速</span>
                                    </label>
                                    <label class="flex items-center p-1 rounded hover:bg-amber-100 dark:hover:bg-gray-600">
                                        <input type="radio" name="quiz-poetry" value="B" class="mr-2">
                                        <span class="text-sm">木兰迅速奔赴战场，翻越千山万水</span>
                                    </label>
                                    <label class="flex items-center p-1 rounded hover:bg-amber-100 dark:hover:bg-gray-600">
                                        <input type="radio" name="quiz-poetry" value="C" class="mr-2">
                                        <span class="text-sm">战场离家很远，路途艰辛</span>
                                    </label>
                                </div>
                                <button class="check-answer mt-2 px-2 py-1 bg-amber-700 text-white text-sm rounded" data-quiz="poetry" data-answer="B">提交答案</button>
                            </div>
                        </div>
                    </div>
                    
                    <button id="finish-riding" class="mt-4 px-4 py-2 bg-red-800 text-white rounded hover:bg-red-700 hidden">完成训练</button>
                </div>
                
                <!-- 3. 战友关系网络 -->
                <div id="comrade-network" class="mb-8 hidden">
                    <h3 class="text-xl font-bold mb-3">战友关系网络 👥</h3>
                    <p class="mb-3">与战友建立良好关系可以获得帮助，但也增加了暴露身份的风险。</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="comrade-card bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                            <div class="flex items-center mb-3">
                                <span class="text-3xl mr-3">👨‍🦳</span>
                                <div>
                                    <h4 class="font-bold">张顺 - 严厉老兵</h4>
                                    <div class="flex items-center">
                                        <p class="text-sm mr-2">关系：</p>
                                        <div class="w-20 h-2 bg-gray-200 rounded-full">
                                            <div class="comrade-relation bg-blue-500 h-2 rounded-full" style="width: 30%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p class="text-sm mb-3">军中资深老兵，对新兵要求极严，但内心重情义。最初对木兰颇有微词，但看到她刻苦训练后态度有所缓和。</p>
                            <div class="space-y-2">
                                <button class="interact-comrade w-full py-1 bg-amber-100 dark:bg-gray-600 hover:bg-amber-200 rounded text-sm" data-comrade="zhang" data-action="train">一起训练</button>
                                <button class="interact-comrade w-full py-1 bg-amber-100 dark:bg-gray-600 hover:bg-amber-200 rounded text-sm" data-comrade="zhang" data-action="advice">请教战术</button>
                            </div>
                        </div>
                        
                        <div class="comrade-card bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                            <div class="flex items-center mb-3">
                                <span class="text-3xl mr-3">👱‍♂️</span>
                                <div>
                                    <h4 class="font-bold">小李 - 热情新兵</h4>
                                    <div class="flex items-center">
                                        <p class="text-sm mr-2">关系：</p>
                                        <div class="w-20 h-2 bg-gray-200 rounded-full">
                                            <div class="comrade-relation bg-blue-500 h-2 rounded-full" style="width: 60%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p class="text-sm mb-3">与木兰同期入伍的年轻士兵，性格开朗热情，但有时过于直率。经常找木兰聊天，话题涉及家人和过去。</p>
                            <div class="space-y-2">
                                <button class="interact-comrade w-full py-1 bg-amber-100 dark:bg-gray-600 hover:bg-amber-200 rounded text-sm" data-comrade="li" data-action="chat">闲聊家乡</button>
                                <button class="interact-comrade w-full py-1 bg-amber-100 dark:bg-gray-600 hover:bg-amber-200 rounded text-sm" data-comrade="li" data-action="avoid">委婉回避</button>
                            </div>
                        </div>
                        
                        <div class="comrade-card bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                            <div class="flex items-center mb-3">
                                <span class="text-3xl mr-3">🧔</span>
                                <div>
                                    <h4 class="font-bold">王伟 - 观察敏锐的副官</h4>
                                    <div class="flex items-center">
                                        <p class="text-sm mr-2">关系：</p>
                                        <div class="w-20 h-2 bg-gray-200 rounded-full">
                                            <div class="comrade-relation bg-blue-500 h-2 rounded-full" style="width: 40%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p class="text-sm mb-3">军营中的副官，观察力极强，负责管理日常事务。对木兰有些怀疑，但未明确表示。最危险的潜在威胁。</p>
                            <div class="space-y-2">
                                <button class="interact-comrade w-full py-1 bg-amber-100 dark:bg-gray-600 hover:bg-amber-200 rounded text-sm" data-comrade="wang" data-action="report">主动报告</button>
                                <button class="interact-comrade w-full py-1 bg-amber-100 dark:bg-gray-600 hover:bg-amber-200 rounded text-sm" data-comrade="wang" data-action="distance">保持距离</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="interaction-result" class="mt-4 p-4 bg-amber-100 dark:bg-gray-700 rounded-lg hidden">
                        <!-- 动态填充交互结果 -->
                    </div>
                    
                    <button id="finish-social" class="mt-4 px-4 py-2 bg-red-800 text-white rounded hover:bg-red-700 hidden">完成社交</button>
                </div>
                
                <!-- 关卡完成信息 -->
                <div id="level-completion-3" class="hidden">
                    <div class="p-4 border-2 border-green-500 rounded-lg">
                        <h3 class="text-xl font-bold text-green-600 dark:text-green-400 mb-2">关卡完成！</h3>
                        <p>通过这个关卡，你体验了木兰在军营中保守秘密的压力和与战友建立关系的微妙平衡。</p>
                        <p class="mt-2 font-bold">IB概念反思：身份认同与社会关系</p>
                        <p class="text-sm italic">木兰必须在军营中保持"假面具"，这种双重身份对个人心理有何影响？在群体中隐藏真实自我与建立真诚友谊之间，如何平衡？</p>
                        
                        <div class="mt-4">
                            <p class="font-bold">情感状态变化：</p>
                            <div id="emotion-changes-3" class="grid grid-cols-2 gap-2 text-sm">
                                <!-- 动态填充 -->
                            </div>
                        </div>
                        
                        <button class="continue-btn mt-4 px-4 py-2 bg-red-800 text-white rounded hover:bg-red-700">继续游戏</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 关卡四：沙场点兵 -->
        <div id="level-4" class="level-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold chinese-brush text-amber-800 dark:text-amber-500">关卡四：沙场点兵</h2>
                <button class="back-to-map p-2 bg-amber-700 text-white rounded hover:bg-amber-600">
                    返回地图
                </button>
            </div>
            
            <div class="bg-amber-50 dark:bg-gray-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="mb-6">
                    <h3 class="text-xl font-bold mb-3">木兰参与战斗，展现军事才能</h3>
                    <p class="mb-3">经过多年军营历练，木兰的武艺和战略才能得到认可。如今，她将面临真正的战场考验，同时探索中国历史上其他巾帼英雄的事迹。</p>
                    <p class="italic mb-3">木兰被任命为一支小队的队长，将带领战友们参与一场关键战役。</p>
                </div>
                
                <!-- 1. 战功诗句记忆配对 -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold mb-3">战功诗句记忆配对 📜</h3>
                    <p class="mb-3">将《木兰诗》中描述战功的诗句正确配对，展现木兰的军旅生涯。</p>
                    
                    <div class="memory-game">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="space-y-2">
                                <h4 class="font-bold">诗句上半部分：</h4>
                                <div class="verse-item bg-white dark:bg-gray-700 p-3 rounded-lg shadow cursor-pointer hover:bg-amber-100 dark:hover:bg-gray-600" data-verse="1">
                                    万里赴戎机
                                </div>
                                <div class="verse-item bg-white dark:bg-gray-700 p-3 rounded-lg shadow cursor-pointer hover:bg-amber-100 dark:hover:bg-gray-600" data-verse="2">
                                    朔气传金柝
                                </div>
                                <div class="verse-item bg-white dark:bg-gray-700 p-3 rounded-lg shadow cursor-pointer hover:bg-amber-100 dark:hover:bg-gray-600" data-verse="3">
                                    将军百战死
                                </div>
                                <div class="verse-item bg-white dark:bg-gray-700 p-3 rounded-lg shadow cursor-pointer hover:bg-amber-100 dark:hover:bg-gray-600" data-verse="4">
                                    不闻爷娘唤女声
                                </div>
                            </div>
                            <div class="space-y-2">
                                <h4 class="font-bold">诗句下半部分：</h4>
                                <div class="verse-item bg-white dark:bg-gray-700 p-3 rounded-lg shadow cursor-pointer hover:bg-amber-100 dark:hover:bg-gray-600" data-verse="4">
                                    但闻黄河流水鸣溅溅
                                </div>
                                <div class="verse-item bg-white dark:bg-gray-700 p-3 rounded-lg shadow cursor-pointer hover:bg-amber-100 dark:hover:bg-gray-600" data-verse="1">
                                    关山度若飞
                                </div>
                                <div class="verse-item bg-white dark:bg-gray-700 p-3 rounded-lg shadow cursor-pointer hover:bg-amber-100 dark:hover:bg-gray-600" data-verse="3">
                                    壮士十年归
                                </div>
                                <div class="verse-item bg-white dark:bg-gray-700 p-3 rounded-lg shadow cursor-pointer hover:bg-amber-100 dark:hover:bg-gray-600" data-verse="2">
                                    寒光照铁衣
                                </div>
                            </div>
                        </div>
                        
                        <div id="selected-verses" class="mb-4">
                            <h4 class="font-bold mb-2">已选择：</h4>
                            <div id="verse-pair" class="bg-amber-100 dark:bg-gray-700 p-3 rounded-lg text-center">
                                <span id="first-verse">请选择第一句...</span>
                                <span id="second-verse" class="hidden">请选择第二句...</span>
                            </div>
                        </div>
                        
                        <div id="matched-verses" class="space-y-2">
                            <h4 class="font-bold mb-2">已匹配：(<span id="match-count">0</span>/3)</h4>
                            <div id="matched-list" class="space-y-1">
                                <!-- 动态填充 -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 2. 巾帼英雄卡片收集 -->
                <div id="heroines-collection" class="mb-8 hidden">
                    <h3 class="text-xl font-bold mb-3">巾帼英雄卡片收集 👑</h3>
                    <p class="mb-3">在战场上，木兰发现了记载中国历史上其他女英雄事迹的卷轴。收集并了解这些女英雄的故事，探索她们的精神与木兰的共鸣。</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <!-- 穆桂英卡片 -->
                        <div class="heroine-card bg-white dark:bg-gray-700 p-4 rounded-lg shadow hover:shadow-md">
                            <div class="flex items-center mb-3">
                                <span class="text-3xl mr-3">👸</span>
                                <h4 class="font-bold">穆桂英</h4>
                            </div>
                            <div class="heroine-content">
                                <div class="heroine-tab active" data-tab="intro">
                                    <h5 class="font-bold mb-1">人物简介</h5>
                                    <p class="text-sm">北宋杨家将第三代女将，精通兵法、武艺高强。嫁给杨宗保后与杨家将共同保卫边疆。</p>
                                </div>
                                <div class="heroine-tab hidden" data-tab="deeds">
                                    <h5 class="font-bold mb-1">主要事迹</h5>
                                    <ul class="text-sm list-disc pl-5">
                                        <li>天波府比武招亲，智勇双全</li>
                                        <li>挂帅出征西辽，大破天门阵</li>
                                        <li>老当益壮，年过六旬仍领兵御敌</li>
                                    </ul>
                                </div>
                                <div class="heroine-tab hidden" data-tab="traits">
                                    <h5 class="font-bold mb-1">个人特质</h5>
                                    <p class="text-sm">沉着冷静，足智多谋，武艺高强，忠于国家。</p>
                                </div>
                                <div class="heroine-tab hidden" data-tab="meaning">
                                    <h5 class="font-bold mb-1">历史意义</h5>
                                    <p class="text-sm">突破性别界限，成为军事指挥官，证明女性同样能够指挥千军万马。</p>
                                </div>
                            </div>
                            <div class="flex justify-between mt-3 border-t pt-2">
                                <button class="tab-btn px-2 py-1 bg-amber-100 dark:bg-gray-600 rounded hover:bg-amber-200 text-xs active" data-heroine="muguiying" data-tab="intro">简介</button>
                                <button class="tab-btn px-2 py-1 bg-amber-100 dark:bg-gray-600 rounded hover:bg-amber-200 text-xs" data-heroine="muguiying" data-tab="deeds">事迹</button>
                                <button class="tab-btn px-2 py-1 bg-amber-100 dark:bg-gray-600 rounded hover:bg-amber-200 text-xs" data-heroine="muguiying" data-tab="traits">特质</button>
                                <button class="tab-btn px-2 py-1 bg-amber-100 dark:bg-gray-600 rounded hover:bg-amber-200 text-xs" data-heroine="muguiying" data-tab="meaning">意义</button>
                            </div>
                            <div class="mt-3 border-t pt-2">
                                <h5 class="font-bold text-sm mb-1">微型挑战：神箭手</h5>
                                <p class="text-xs mb-2">击中移动靶，展示箭术精准度。</p>
                                <button class="heroine-challenge px-3 py-1 bg-red-800 text-white rounded text-sm hover:bg-red-700" data-heroine="muguiying">开始挑战</button>
                            </div>
                        </div>
                        
                        <!-- 梁红玉卡片 -->
                        <div class="heroine-card bg-white dark:bg-gray-700 p-4 rounded-lg shadow hover:shadow-md">
                            <div class="flex items-center mb-3">
                                <span class="text-3xl mr-3">👸</span>
                                <h4 class="font-bold">梁红玉</h4>
                            </div>
                            <div class="heroine-content">
                                <div class="heroine-tab active" data-tab="intro">
                                    <h5 class="font-bold mb-1">人物简介</h5>
                                    <p class="text-sm">南宋女将，韩世忠之妻。原为歌妓，后随夫从军，亲临战场指挥作战。</p>
                                </div>
                                <div class="heroine-tab hidden" data-tab="deeds">
                                    <h5 class="font-bold mb-1">主要事迹</h5>
                                    <ul class="text-sm list-disc pl-5">
                                        <li>金兵围困采石矶，亲擂战鼓鼓舞士气</li>
                                        <li>协助丈夫抗击金兵入侵，保卫南宋</li>
                                        <li>与丈夫韩世忠共同守卫淮南东路</li>
                                    </ul>
                                </div>
                                <div class="heroine-tab hidden" data-tab="traits">
                                    <h5 class="font-bold mb-1">个人特质</h5>
                                    <p class="text-sm">勇敢无畏，临危不惧，有音乐天赋，精通鼓点。</p>
                                </div>
                                <div class="heroine-tab hidden" data-tab="meaning">
                                    <h5 class="font-bold mb-1">历史意义</h5>
                                    <p class="text-sm">平民女性通过自身努力成为军事领袖，打破身份和性别双重限制。</p>
                                </div>
                            </div>
                            <div class="flex justify-between mt-3 border-t pt-2">
                                <button class="tab-btn px-2 py-1 bg-amber-100 dark:bg-gray-600 rounded hover:bg-amber-200 text-xs active" data-heroine="lianghongyu" data-tab="intro">简介</button>
                                <button class="tab-btn px-2 py-1 bg-amber-100 dark:bg-gray-600 rounded hover:bg-amber-200 text-xs" data-heroine="lianghongyu" data-tab="deeds">事迹</button>
                                <button class="tab-btn px-2 py-1 bg-amber-100 dark:bg-gray-600 rounded hover:bg-amber-200 text-xs" data-heroine="lianghongyu" data-tab="traits">特质</button>
                                <button class="tab-btn px-2 py-1 bg-amber-100 dark:bg-gray-600 rounded hover:bg-amber-200 text-xs" data-heroine="lianghongyu" data-tab="meaning">意义</button>
                            </div>
                            <div class="mt-3 border-t pt-2">
                                <h5 class="font-bold text-sm mb-1">微型挑战：擂鼓助威</h5>
                                <p class="text-xs mb-2">按节奏击鼓，提升军队士气。</p>
                                <button class="heroine-challenge px-3 py-1 bg-red-800 text-white rounded text-sm hover:bg-red-700" data-heroine="lianghongyu">开始挑战</button>
                            </div>
                        </div>
                        
                        <!-- 秦良玉卡片 -->
                        <div class="heroine-card bg-white dark:bg-gray-700 p-4 rounded-lg shadow hover:shadow-md">
                            <div class="flex items-center mb-3">
                                <span class="text-3xl mr-3">👸</span>
                                <h4 class="font-bold">秦良玉</h4>
                            </div>
                            <div class="heroine-content">
                                <div class="heroine-tab active" data-tab="intro">
                                    <h5 class="font-bold mb-1">人物简介</h5>
                                    <p class="text-sm">明末清初女将，率领"白杆兵"效忠明朝，抗击农民起义军和清军。</p>
                                </div>
                                <div class="heroine-tab hidden" data-tab="deeds">
                                    <h5 class="font-bold mb-1">主要事迹</h5>
                                    <ul class="text-sm list-disc pl-5">
                                        <li>率领白杆兵参与平定张献忠起义</li>
                                        <li>跟随南明政权抗清</li>
                                        <li>终生不降清朝，保持民族气节</li>
                                    </ul>
                                </div>
                                <div class="heroine-tab hidden" data-tab="traits">
                                    <h5 class="font-bold mb-1">个人特质</h5>
                                    <p class="text-sm">忠贞不渝，英勇善战，指挥有方，重情义。</p>
                                </div>
                                <div class="heroine-tab hidden" data-tab="meaning">
                                    <h5 class="font-bold mb-1">历史意义</h5>
                                    <p class="text-sm">少数民族女性军事指挥官，展现了非汉族女性的卓越军事才能。</p>
                                </div>
                            </div>
                            <div class="flex justify-between mt-3 border-t pt-2">
                                <button class="tab-btn px-2 py-1 bg-amber-100 dark:bg-gray-600 rounded hover:bg-amber-200 text-xs active" data-heroine="qinliangyu" data-tab="intro">简介</button>
                                <button class="tab-btn px-2 py-1 bg-amber-100 dark:bg-gray-600 rounded hover:bg-amber-200 text-xs" data-heroine="qinliangyu" data-tab="deeds">事迹</button>
                                <button class="tab-btn px-2 py-1 bg-amber-100 dark:bg-gray-600 rounded hover:bg-amber-200 text-xs" data-heroine="qinliangyu" data-tab="traits">特质</button>
                                <button class="tab-btn px-2 py-1 bg-amber-100 dark:bg-gray-600 rounded hover:bg-amber-200 text-xs" data-heroine="qinliangyu" data-tab="meaning">意义</button>
                            </div>
                            <div class="mt-3 border-t pt-2">
                                <h5 class="font-bold text-sm mb-1">微型挑战：兵力部署</h5>
                                <p class="text-xs mb-2">合理安排有限兵力守卫多个位置。</p>
                                <button class="heroine-challenge px-3 py-1 bg-red-800 text-white rounded text-sm hover:bg-red-700" data-heroine="qinliangyu">开始挑战</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 3. 巾帼风云：历史映照 -->
                <div id="historical-reflection" class="mb-8 hidden">
                    <h3 class="text-xl font-bold mb-3">巾帼风云：历史映照 🏮</h3>
                    <p class="mb-3">木兰在战场遇到各种情境，需要做出决策。你的选择会与历史上其他女英雄的行为相映照。</p>
                    
                    <div class="scenario bg-amber-100 dark:bg-gray-700 p-4 rounded-lg mb-4">
                        <h4 class="font-bold mb-2">情境一：军粮短缺</h4>
                        <p class="mb-3">连日征战，军粮告急，士兵们饥肠辘辘，士气低落。作为小队长，木兰应该如何处理？</p>
                        
                        <div class="space-y-2">
                            <label class="flex items-start p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                                <input type="radio" name="scenario-food" value="A" class="mt-1 mr-2">
                                <div>
                                    <p class="font-bold">A. 个人带头减少口粮，与士兵同甘共苦</p>
                                    <p class="text-sm text-gray-500">优先确保士兵基本温饱</p>
                                </div>
                            </label>
                            <label class="flex items-start p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                                <input type="radio" name="scenario-food" value="B" class="mt-1 mr-2">
                                <div>
                                    <p class="font-bold">B. 派人寻找当地资源，解决燃眉之急</p>
                                    <p class="text-sm text-gray-500">临机应变，就地取材</p>
                                </div>
                            </label>
                            <label class="flex items-start p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                                <input type="radio" name="scenario-food" value="C" class="mt-1 mr-2">
                                <div>
                                    <p class="font-bold">C. 鼓舞士气，强调坚持就会等到援军</p>
                                    <p class="text-sm text-gray-500">精神激励为主</p>
                                </div>
                            </label>
                        </div>
                        
                        <div id="reflection-food" class="reflection-result mt-4 p-3 bg-white dark:bg-gray-600 rounded-lg hidden">
                            <!-- 动态填充反思结果 -->
                        </div>
                        
                        <button id="submit-scenario-food" class="mt-3 px-3 py-1 bg-red-800 text-white rounded hover:bg-red-700">确认选择</button>
                    </div>
                    
                    <div id="scenario-command" class="scenario bg-amber-100 dark:bg-gray-700 p-4 rounded-lg mb-4 hidden">
                        <h4 class="font-bold mb-2">情境二：指挥危机</h4>
                        <p class="mb-3">战场局势突变，原计划被打乱。木兰需要在短时间内作出新的指挥决策。</p>
                        
                        <div class="space-y-2">
                            <label class="flex items-start p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                                <input type="radio" name="scenario-command" value="A" class="mt-1 mr-2">
                                <div>
                                    <p class="font-bold">A. 严格按照军令行事，遵循既定战略</p>
                                    <p class="text-sm text-gray-500">遵守军纪，不擅自改变</p>
                                </div>
                            </label>
                            <label class="flex items-start p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                                <input type="radio" name="scenario-command" value="B" class="mt-1 mr-2">
                                <div>
                                    <p class="font-bold">B. 根据实际情况临机决策，灵活应对</p>
                                    <p class="text-sm text-gray-500">随机应变，因地制宜</p>
                                </div>
                            </label>
                            <label class="flex items-start p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                                <input type="radio" name="scenario-command" value="C" class="mt-1 mr-2">
                                <div>
                                    <p class="font-bold">C. 撤退保存实力，等待更好时机</p>
                                    <p class="text-sm text-gray-500">避免不必要的牺牲</p>
                                </div>
                            </label>
                        </div>
                        
                        <div id="reflection-command" class="reflection-result mt-4 p-3 bg-white dark:bg-gray-600 rounded-lg hidden">
                            <!-- 动态填充反思结果 -->
                        </div>
                        
                        <button id="submit-scenario-command" class="mt-3 px-3 py-1 bg-red-800 text-white rounded hover:bg-red-700">确认选择</button>
                    </div>
                    
                    <div id="scenario-identity" class="scenario bg-amber-100 dark:bg-gray-700 p-4 rounded-lg mb-4 hidden">
                        <h4 class="font-bold mb-2">情境三：身份困境</h4>
                        <p class="mb-3">战场上，一名受伤战友需要紧急处理伤口，可能会暴露木兰的身份。</p>
                        
                        <div class="space-y-2">
                            <label class="flex items-start p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                                <input type="radio" name="scenario-identity" value="A" class="mt-1 mr-2">
                                <div>
                                    <p class="font-bold">A. 找借口避开，安排其他人处理</p>
                                    <p class="text-sm text-gray-500">保护自己的秘密</p>
                                </div>
                            </label>
                            <label class="flex items-start p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                                <input type="radio" name="scenario-identity" value="B" class="mt-1 mr-2">
                                <div>
                                    <p class="font-bold">B. 冒险救助，尽量避免暴露</p>
                                    <p class="text-sm text-gray-500">在保密和救人间寻找平衡</p>
                                </div>
                            </label>
                            <label class="flex items-start p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                                <input type="radio" name="scenario-identity" value="C" class="mt-1 mr-2">
                                <div>
                                    <p class="font-bold">C. 无条件救助，即使可能暴露身份</p>
                                    <p class="text-sm text-gray-500">以救人为第一优先</p>
                                </div>
                            </label>
                        </div>
                        
                        <div id="reflection-identity" class="reflection-result mt-4 p-3 bg-white dark:bg-gray-600 rounded-lg hidden">
                            <!-- 动态填充反思结果 -->
                        </div>
                        
                        <button id="submit-scenario-identity" class="mt-3 px-3 py-1 bg-red-800 text-white rounded hover:bg-red-700">确认选择</button>
                    </div>
                </div>
                
                <!-- 4. 关卡完成信息 -->
                <div id="level-completion-4" class="hidden">
                    <div class="p-4 border-2 border-green-500 rounded-lg">
                        <h3 class="text-xl font-bold text-green-600 dark:text-green-400 mb-2">关卡完成！</h3>
                        <p>通过这个关卡，你不仅体验了木兰在战场上的表现，还了解了中国历史上其他巾帼英雄的事迹。</p>
                        <p class="mt-2 font-bold">IB概念反思：性别与领导力</p>
                        <p class="text-sm italic">通过历史女英雄群像，我们可以看到不同时期女性如何突破社会限制，展现卓越领导能力。这些故事如何挑战了传统性别刻板印象？不同历史背景下的女性领导者有哪些共同特质？</p>
                        
                        <div class="mt-4">
                            <p class="font-bold">情感状态变化：</p>
                            <div id="emotion-changes-4" class="grid grid-cols-2 gap-2 text-sm">
                                <!-- 动态填充 -->
                            </div>
                        </div>
                        
                        <button class="continue-btn mt-4 px-4 py-2 bg-red-800 text-white rounded hover:bg-red-700">继续游戏</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 关卡五：功成名就 -->
        <div id="level-5" class="level-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold chinese-brush text-amber-800 dark:text-amber-500">关卡五：功成名就</h2>
                <button class="back-to-map p-2 bg-amber-700 text-white rounded hover:bg-amber-600">
                    返回地图
                </button>
            </div>
            
            <div class="bg-amber-50 dark:bg-gray-800 rounded-lg p-6 shadow-lg mb-6">
                <div class="mb-6">
                    <h3 class="text-xl font-bold mb-3">木兰立下战功，面临升官与归家的抉择</h3>
                    <p class="mb-3">战争结束了，木兰因战功卓著得到朝廷嘉奖。可汗欲封她为高官，但木兰心中却想着家乡。</p>
                    <p class="italic mb-3">十二年的军旅生涯终于结束，木兰面临人生的重要抉择。</p>
                    <div class="border-l-4 border-red-800 pl-4 py-2 mb-3 bg-amber-100 dark:bg-gray-700 italic">
                        <p>可汗问所欲，木兰不用尚书郎，愿驰千里足，送儿还故乡。</p>
                    </div>
                </div>
                
                <!-- 1. 最终抉择 -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold mb-3">最终抉择 🏆</h3>
                    <p class="mb-3">可汗因木兰的功勋要赏赐她，木兰该做出怎样的选择？这个决定将影响她的未来，也会决定游戏的结局。</p>
                    
                    <div class="space-y-4">
                        <label class="flex items-start p-3 rounded border border-amber-700 hover:bg-amber-100 dark:hover:bg-gray-700">
                            <input type="radio" name="final-choice" value="A" class="mt-1 mr-2">
                            <div>
                                <p class="font-bold">A. 接受官职</p>
                                <p class="text-sm">接受可汗的封赏，成为朝廷高官，继续以男装身份生活</p>
                                <p class="text-xs italic mt-1">影响：获得权力和地位，但需永远隐藏真实身份</p>
                            </div>
                        </label>
                        <label class="flex items-start p-3 rounded border border-amber-700 hover:bg-amber-100 dark:hover:bg-gray-700">
                            <input type="radio" name="final-choice" value="B" class="mt-1 mr-2">
                            <div>
                                <p class="font-bold">B. 请求回乡</p>
                                <p class="text-sm">婉拒官职，请求回到家乡与亲人团聚</p>
                                <p class="text-xs italic mt-1">影响：放弃权势，回归家庭和真实身份</p>
                            </div>
                        </label>
                        <label class="flex items-start p-3 rounded border border-amber-700 hover:bg-amber-100 dark:hover:bg-gray-700">
                            <input type="radio" name="final-choice" value="C" class="mt-1 mr-2">
                            <div>
                                <p class="font-bold">C. 请求特殊恩赐</p>
                                <p class="text-sm">向可汗坦白身份，请求特殊恩赐</p>
                                <p class="text-xs italic mt-1">影响：冒巨大风险，但可能获得前所未有的机会</p>
                            </div>
                        </label>
                        <label class="flex items-start p-3 rounded border border-amber-700 hover:bg-amber-100 dark:hover:bg-gray-700">
                            <input type="radio" name="final-choice" value="D" class="mt-1 mr-2">
                            <div>
                                <p class="font-bold">D. 另辟蹊径</p>
                                <p class="text-sm">请求不做官，但获得特许开办军事学堂</p>
                                <p class="text-xs italic mt-1">影响：可以发挥所长，但仍需隐藏身份</p>
                            </div>
                        </label>
                    </div>
                    
                    <button id="submit-final-choice" class="mt-4 px-4 py-2 bg-red-800 text-white rounded hover:bg-red-700">确认选择</button>
                </div>
                
                <!-- 2. 完成《木兰诗》结尾填空 -->
                <div id="final-poem" class="mb-8 hidden">
                    <h3 class="text-xl font-bold mb-3">完成《木兰诗》结尾 📝</h3>
                    <p class="mb-3">请填写《木兰诗》结尾部分，描述木兰回家后恢复女儿身的场景：</p>
                    
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg border border-amber-700 mb-4">
                        <p class="poem-line mb-2">
                            爷娘闻女来，出郭相扶<span class="blank" data-answer="将"></span>；
                        </p>
                        <p class="poem-line mb-2">
                            阿姊闻妹来，<span class="blank" data-answer="当户理红妆"></span>；
                        </p>
                        <p class="poem-line mb-2">
                            小弟闻姊来，磨刀霍霍<span class="blank" data-answer="向猪羊"></span>。
                        </p>
                        <p class="poem-line mb-2">
                            开我东阁门，坐我<span class="blank" data-answer="西阁床"></span>，
                        </p>
                        <p class="poem-line mb-2">
                            脱我战时袍，著我<span class="blank" data-answer="旧时裳"></span>。
                        </p>
                        <p class="poem-line mb-2">
                            当窗理云鬓，<span class="blank" data-answer="对镜贴花黄"></span>。
                        </p>
                        <p class="poem-line mb-2">
                            <span class="blank" data-answer="出门看火伴"></span>，火伴皆惊忙：
                        </p>
                        <p class="poem-line mb-2">
                            同行十二年，不知木兰是<span class="blank" data-answer="女郎"></span>。
                        </p>
                    </div>
                    
                    <div class="mt-4 flex flex-wrap gap-2" id="word-bank-5">
                        <button class="word-choice px-3 py-1 bg-amber-200 text-gray-800 rounded hover:bg-amber-300">将</button>
                        <button class="word-choice px-3 py-1 bg-amber-200 text-gray-800 rounded hover:bg-amber-300">当户理红妆</button>
                        <button class="word-choice px-3 py-1 bg-amber-200 text-gray-800 rounded hover:bg-amber-300">当窗理青丝</button>
                        <button class="word-choice px-3 py-1 bg-amber-200 text-gray-800 rounded hover:bg-amber-300">向猪羊</button>
                        <button class="word-choice px-3 py-1 bg-amber-200 text-gray-800 rounded hover:bg-amber-300">西阁床</button>
                        <button class="word-choice px-3 py-1 bg-amber-200 text-gray-800 rounded hover:bg-amber-300">时裳</button>
                        <button class="word-choice px-3 py-1 bg-amber-200 text-gray-800 rounded hover:bg-amber-300">旧时裳</button>
                        <button class="word-choice px-3 py-1 bg-amber-200 text-gray-800 rounded hover:bg-amber-300">对镜贴花黄</button>
                        <button class="word-choice px-3 py-1 bg-amber-200 text-gray-800 rounded hover:bg-amber-300">出门看火伴</button>
                        <button class="word-choice px-3 py-1 bg-amber-200 text-gray-800 rounded hover:bg-amber-300">女郎</button>
                    </div>
                    
                    <button id="check-poem" class="mt-4 px-4 py-2 bg-red-800 text-white rounded hover:bg-red-700">检查诗句</button>
                </div>
                
                <!-- 3. 情感配对 -->
                <div id="emotion-matching" class="mb-8 hidden">
                    <h3 class="text-xl font-bold mb-3">情感配对 ❤️</h3>
                    <p class="mb-3">匹配木兰不同阶段的情感变化与诗句表达：</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <h4 class="font-bold mb-2">情感阶段：</h4>
                            <div class="space-y-2">
                                <div class="emotion-item p-2 border border-amber-700 rounded-lg bg-white dark:bg-gray-700 cursor-move" data-emotion="A" draggable="true">
                                    闻军令时的忧虑 😟
                                </div>
                                <div class="emotion-item p-2 border border-amber-700 rounded-lg bg-white dark:bg-gray-700 cursor-move" data-emotion="B" draggable="true">
                                    决定从军时的决心 💪
                                </div>
                                <div class="emotion-item p-2 border border-amber-700 rounded-lg bg-white dark:bg-gray-700 cursor-move" data-emotion="C" draggable="true">
                                    战场上的勇敢 ⚔️
                                </div>
                                <div class="emotion-item p-2 border border-amber-700 rounded-lg bg-white dark:bg-gray-700 cursor-move" data-emotion="D" draggable="true">
                                    凯旋时的喜悦 🎉
                                </div>
                                <div class="emotion-item p-2 border border-amber-700 rounded-lg bg-white dark:bg-gray-700 cursor-move" data-emotion="E" draggable="true">
                                    归家时的释然 😌
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-bold mb-2">诗句表达：</h4>
                            <div class="space-y-2">
                                <div class="verse-item p-2 border border-dashed border-amber-700 rounded-lg bg-amber-50 dark:bg-gray-800 min-h-12" data-verse="A">
                                    <div class="dropzone flex items-center justify-center h-full text-gray-400">
                                        拖放情感到此处
                                    </div>
                                    <p class="verse hidden">不闻机杼声，惟闻女叹息。</p>
                                </div>
                                <div class="verse-item p-2 border border-dashed border-amber-700 rounded-lg bg-amber-50 dark:bg-gray-800 min-h-12" data-verse="B">
                                    <div class="dropzone flex items-center justify-center h-full text-gray-400">
                                        拖放情感到此处
                                    </div>
                                    <p class="verse hidden">万里赴戎机，关山度若飞。</p>
                                </div>
                                <div class="verse-item p-2 border border-dashed border-amber-700 rounded-lg bg-amber-50 dark:bg-gray-800 min-h-12" data-verse="C">
                                    <div class="dropzone flex items-center justify-center h-full text-gray-400">
                                        拖放情感到此处
                                    </div>
                                    <p class="verse hidden">朔气传金柝，寒光照铁衣。</p>
                                </div>
                                <div class="verse-item p-2 border border-dashed border-amber-700 rounded-lg bg-amber-50 dark:bg-gray-800 min-h-12" data-verse="D">
                                    <div class="dropzone flex items-center justify-center h-full text-gray-400">
                                        拖放情感到此处
                                    </div>
                                    <p class="verse hidden">归来见天子，天子坐明堂。</p>
                                </div>
                                <div class="verse-item p-2 border border-dashed border-amber-700 rounded-lg bg-amber-50 dark:bg-gray-800 min-h-12" data-verse="E">
                                    <div class="dropzone flex items-center justify-center h-full text-gray-400">
                                        拖放情感到此处
                                    </div>
                                    <p class="verse hidden">脱我战时袍，著我旧时裳。</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button id="check-emotion-matching" class="mt-4 px-4 py-2 bg-red-800 text-white rounded hover:bg-red-700">检查配对</button>
                </div>
                
                <!-- 4. 关卡完成信息 -->
                <div id="level-completion-5" class="hidden">
                    <div class="p-4 border-2 border-green-500 rounded-lg">
                        <h3 class="text-xl font-bold text-green-600 dark:text-green-400 mb-2">关卡完成！</h3>
                        <p>恭喜你完成了所有关卡！木兰的故事告诉我们，勇气、智慧和家国情怀可以超越性别的界限。</p>
                        <p class="mt-2 font-bold">IB概念反思：价值观、身份与目的</p>
                        <p class="text-sm italic">木兰最终选择归家，放弃了荣华富贵。这反映了她对家庭的看重高于个人成就。思考在当代社会中，人们如何平衡个人成就与家庭责任？</p>
                        
                        <div class="mt-4">
                            <p class="font-bold">最终情感状态：</p>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div>勇气: <span id="final-courage">--</span></div>
                                <div>思乡: <span id="final-homesick">--</span></div>
                                <div>决心: <span id="final-determination">--</span></div>
                                <div>恐惧: <span id="final-fear">--</span></div>
                            </div>
                        </div>
                        
                        <div class="mt-6 flex justify-center">
                            <button id="view-ending" class="px-6 py-3 bg-red-800 text-white rounded-lg hover:bg-red-700">查看结局</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 结局屏幕 -->
        <div id="ending-screen" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold chinese-brush text-amber-800 dark:text-amber-500">木兰从军记 - 结局</h2>
                <button id="back-to-home" class="p-2 bg-amber-700 text-white rounded hover:bg-amber-600">
                    返回主页
                </button>
            </div>
            
            <!-- 标准结局：荣归故里 -->
            <div id="standard-ending" class="bg-amber-50 dark:bg-gray-800 rounded-lg p-6 shadow-lg mb-6 hidden">
                <h3 class="text-2xl font-bold mb-4 text-center">荣归故里 🏡</h3>
                
                <p class="mb-3">木兰辞官不受，骑上快马回到家乡。她脱下战袍，换上女儿装，恢复了真实的身份。</p>
                
                <div class="border-l-4 border-red-800 pl-4 py-2 mb-4 bg-amber-100 dark:bg-gray-700 italic">
                    <p>当窗理云鬓，对镜贴花黄。出门看火伴，火伴皆惊忙：</p>
                    <p>同行十二年，不知木兰是女郎。</p>
                </div>
                
                <p class="mb-3">当年与木兰一同作战的战友们得知她的真实身份后，无不惊讶万分。一个女子不仅能够在军中生存，更立下赫赫战功，这在当时的社会里是多么不可思议的事情。</p>
                
                <p class="mb-3">木兰回归家庭的选择，展现了她对家庭的珍视高于个人功名利禄。她完成了保卫国家的使命，也履行了对家庭的责任。</p>
                
                <p class="mb-5">在那个男女有别的时代，木兰以她的勇气、智慧和毅力，证明了女性同样能够承担重任，保家卫国。她的故事流传至今，激励着无数后人。</p>
                
                <div class="p-4 bg-amber-100 dark:bg-gray-700 rounded-lg mb-4">
                    <h4 class="font-bold mb-2">情感释放 💭</h4>
                    <p>回到家中的木兰终于能够卸下伪装，释放长期压抑的情感。她流下了喜悦的泪水，感受到了久违的自由和解脱。十二年的军旅生涯留给她的不仅是荣誉，还有对和平与家庭的更深珍视。</p>
                </div>
                
                <div class="text-center mt-6">
                    <button id="play-again" class="px-6 py-3 bg-red-800 text-white rounded-lg hover:bg-red-700">再次体验</button>
                </div>
            </div>
            
            <!-- 失败结局：身份暴露 -->
            <div id="failure-ending" class="bg-amber-50 dark:bg-gray-800 rounded-lg p-6 shadow-lg mb-6 hidden">
                <h3 class="text-2xl font-bold mb-4 text-center text-red-600 dark:text-red-400">身份暴露 ⚠️</h3>
                
                <p class="mb-3">在军中的第十年，一次意外的伤病导致木兰的真实身份被发现。</p>
                
                <p class="mb-3">根据当时的律法，女子冒充男性从军是重罪。尽管木兰功勋卓著，但仍被押往京城审判。</p>
                
                <p class="mb-3">在审判庭上，木兰坚定地陈述了自己的动机：替父从军，保家卫国。她的话感动了在场的官员，但法律严明，很难轻易改变。</p>
                
                <p class="mb-5">木兰最终被判流放边疆。她的故事却在民间广为流传，成为后人传颂的佳话，也成为对那个时代性别不平等的深刻控诉。</p>
                
                <div class="p-4 bg-red-100 dark:bg-red-900 dark:bg-opacity-30 rounded-lg mb-4">
                    <h4 class="font-bold mb-2">历史反思 🔍</h4>
                    <p>木兰的悲剧反映了古代社会对女性的严格限制。即使她有卓越的才能和贡献，仍无法突破性别的樊篱。这提醒我们思考：社会的规范与个人的价值追求发生冲突时，应如何平衡？一个健康的社会应如何看待及接纳"异类"？</p>
                </div>
                
                <div class="text-center mt-6">
                    <button id="retry-game" class="px-6 py-3 bg-red-800 text-white rounded-lg hover:bg-red-700">重新开始</button>
                </div>
            </div>
            
            <!-- 隐藏结局：巾帼将军 -->
            <div id="hidden-ending" class="bg-amber-50 dark:bg-gray-800 rounded-lg p-6 shadow-lg mb-6 hidden">
                <h3 class="text-2xl font-bold mb-4 text-center text-purple-600 dark:text-purple-400">巾帼将军 👑</h3>
                
                <p class="mb-3">战功赫赫的木兰在最后一场决定性战役中救了可汗的命。面对可汗的隆重嘉奖，木兰做出了一个惊人的决定：坦白自己的真实身份。</p>
                
                <p class="mb-3">在朝堂之上，当木兰摘下头盔，露出长发的那一刻，满朝文武皆惊。然而，可汗并未震怒，反而对木兰的勇气和才能更加钦佩。</p>
                
                <p class="mb-3">破例之下，可汗任命木兰为女将军，并下诏改变律法，允许女子参军。这在当时是一项前所未有的变革。</p>
                
                <p class="mb-5">木兰成为了历史上第一位公开身份的女将领，她不仅保家卫国，更推动了社会的进步，为无数女性开辟了新的道路。</p>
                
                <div class="p-4 bg-purple-100 dark:bg-purple-900 dark:bg-opacity-30 rounded-lg mb-4">
                    <h4 class="font-bold mb-2">现代意义 🌟</h4>
                    <p>木兰的故事在这个结局中展现了变革的可能性。她不仅仅是适应了现存的体系，而是通过自己的行动改变了体系本身。这启示我们：真正的变革往往需要勇气去挑战现状，而一个个体的行动可以引发社会的进步。从IB概念看，这体现了人如何通过行动改变社会结构，实现更大的公平和包容。</p>
                </div>
                
                <div class="text-center mt-6">
                    <button id="share-experience" class="px-6 py-3 bg-red-800 text-white rounded-lg hover:bg-red-700">分享体验</button>
                </div>
            </div>
        </div>
        
        <!-- 玩家指南浮窗，帮助玩家理解游戏 -->
        <div id="game-guide" class="fixed bottom-4 right-4 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-lg border border-amber-700 max-w-xs z-20">
            <h3 class="text-lg font-bold mb-2">游戏指南</h3>
            <div id="guide-content">
                <p class="text-sm mb-2">欢迎来到《木兰从军记》！</p>
                <p class="text-sm mb-2">• 在首页选择难度后点击"开始旅程"</p>
                <p class="text-sm mb-2">• 选择关卡进行游戏</p>
                <p class="text-sm mb-2">• 在填空游戏中，点击空白处然后点击词汇</p>
                <p class="text-sm">• 完成关卡后获得通关评价</p>
            </div>
            <div class="flex justify-between mt-3">
                <button id="close-guide" class="px-2 py-1 bg-amber-700 text-white rounded text-xs">关闭</button>
                <button id="show-more-guide" class="px-2 py-1 bg-red-800 text-white rounded text-xs">更多帮助</button>
            </div>
        </div>
    </div>
    
    <script>
        // 游戏状态管理
        const gameState = {
            difficulty: 'easy',
            currentLevel: 0,
            completedLevels: [],
            emotions: {
                courage: 20,
                homesick: 10,
                determination: 30,
                fear: 15
            },
            ending: 'standard', // standard, failure, hidden
            
            // 更新情感状态
            updateEmotion(emotion, value) {
                this.emotions[emotion] += value;
                if (this.emotions[emotion] < 0) this.emotions[emotion] = 0;
                if (this.emotions[emotion] > 100) this.emotions[emotion] = 100;
                this.updateEmotionUI();
            },
            
            // 更新情感UI
            updateEmotionUI() {
                document.getElementById('courage-value').textContent = `${this.emotions.courage}%`;
                document.getElementById('courage-bar').style.width = `${this.emotions.courage}%`;
                
                document.getElementById('homesick-value').textContent = `${this.emotions.homesick}%`;
                document.getElementById('homesick-bar').style.width = `${this.emotions.homesick}%`;
                
                document.getElementById('determination-value').textContent = `${this.emotions.determination}%`;
                document.getElementById('determination-bar').style.width = `${this.emotions.determination}%`;
                
                document.getElementById('fear-value').textContent = `${this.emotions.fear}%`;
                document.getElementById('fear-bar').style.width = `${this.emotions.fear}%`;
            },
            
            // 完成关卡
            completeLevel(level) {
                if (!this.completedLevels.includes(level)) {
                    this.completedLevels.push(level);
                }
                
                // 更新进度文本
                document.getElementById('progress-text').textContent = `${this.completedLevels.length}/5`;
            }
        };
        
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 难度选择按钮
            document.getElementById('easy-btn').addEventListener('click', function() {
                setDifficulty('easy', '小卒');
            });
            
            document.getElementById('medium-btn').addEventListener('click', function() {
                setDifficulty('medium', '百夫长');
            });
            
            document.getElementById('hard-btn').addEventListener('click', function() {
                setDifficulty('hard', '将军');
            });
            
            function setDifficulty(level, displayName) {
                // 移除所有按钮的强调样式
                document.querySelectorAll('.difficulty-btn').forEach(btn => {
                    btn.classList.remove('bg-red-800');
                    btn.classList.add('bg-amber-700');
                });
                
                // 为选中的按钮添加强调样式
                document.getElementById(`${level}-btn`).classList.remove('bg-amber-700');
                document.getElementById(`${level}-btn`).classList.add('bg-red-800');
                
                // 更新游戏状态
                gameState.difficulty = level;
                document.getElementById('current-difficulty').textContent = displayName;
            }
            
            // 开始游戏按钮
            document.getElementById('start-btn').addEventListener('click', function() {
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('level-select').classList.remove('hidden');
                gameState.updateEmotionUI();
            });
            
            // 返回主页按钮
            document.getElementById('home-btn').addEventListener('click', function() {
                hideAllScreens();
                document.getElementById('start-screen').classList.remove('hidden');
            });
            
            // 回到地图按钮
            document.querySelectorAll('.back-to-map').forEach(btn => {
                btn.addEventListener('click', function() {
                    hideAllScreens();
                    document.getElementById('level-select').classList.remove('hidden');
                });
            });
            
            // 继续游戏按钮
            document.querySelectorAll('.continue-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    hideAllScreens();
                    document.getElementById('level-select').classList.remove('hidden');
                });
            });
            
            // 关卡卡片点击事件
            document.getElementById('level-card-1').addEventListener('click', function() {
                gameState.currentLevel = 1;
                hideAllScreens();
                document.getElementById('level-1').classList.remove('hidden');
                initializeLevel1();
            });
            
            document.getElementById('level-card-2').addEventListener('click', function() {
                gameState.currentLevel = 2;
                hideAllScreens();
                document.getElementById('level-2').classList.remove('hidden');
                initializeLevel2();
            });
            
            document.getElementById('level-card-3').addEventListener('click', function() {
                gameState.currentLevel = 3;
                hideAllScreens();
                document.getElementById('level-3').classList.remove('hidden');
                initializeLevel3();
            });
            
            document.getElementById('level-card-4').addEventListener('click', function() {
                gameState.currentLevel = 4;
                hideAllScreens();
                document.getElementById('level-4').classList.remove('hidden');
                initializeLevel4();
            });
            
            document.getElementById('level-card-5').addEventListener('click', function() {
                gameState.currentLevel = 5;
                hideAllScreens();
                document.getElementById('level-5').classList.remove('hidden');
                initializeLevel5();
            });
            
            // 结局屏幕按钮
            document.getElementById('back-to-home').addEventListener('click', function() {
                hideAllScreens();
                document.getElementById('start-screen').classList.remove('hidden');
            });
            
            document.getElementById('play-again').addEventListener('click', function() {
                location.reload();
            });
            
            document.getElementById('retry-game').addEventListener('click', function() {
                location.reload();
            });
            
            document.getElementById('share-experience').addEventListener('click', function() {
                alert('感谢你体验《木兰从军记》！你可以通过截屏或将链接分享给朋友，让他们也来体验这段历史。');
            });
            
            // 游戏指南
            document.getElementById('close-guide').addEventListener('click', function() {
                document.getElementById('game-guide').classList.add('hidden');
            });
            
            document.getElementById('show-more-guide').addEventListener('click', function() {
                const guideContent = document.getElementById('guide-content');
                guideContent.innerHTML = `
                    <p class="text-sm mb-2">《木兰从军记》完整指南：</p>
                    <p class="text-sm mb-1">1. 在首页选择难度（小卒/百夫长/将军）</p>
                    <p class="text-sm mb-1">2. 点击"开始旅程"进入地图</p>
                    <p class="text-sm mb-1">3. 选择关卡进行游戏</p>
                    <p class="text-sm mb-1">4. 填空游戏：先点击空白框，再点选词语</p>
                    <p class="text-sm mb-1">5. 每个关卡完成后可以看到情感变化</p>
                    <p class="text-sm mb-1">6. 最终关卡的选择会影响游戏结局</p>
                    <p class="text-sm mb-1">7. 如有问题，刷新页面重新开始</p>
                `;
                this.textContent = "收起";
                this.removeEventListener('click', arguments.callee);
                this.addEventListener('click', function() {
                    guideContent.innerHTML = `
                        <p class="text-sm mb-2">欢迎来到《木兰从军记》！</p>
                        <p class="text-sm mb-2">• 在首页选择难度后点击"开始旅程"</p>
                        <p class="text-sm mb-2">• 选择关卡进行游戏</p>
                        <p class="text-sm mb-2">• 在填空游戏中，点击空白处然后点击词汇</p>
                        <p class="text-sm">• 完成关卡后获得通关评价</p>
                    `;
                    this.textContent = "更多帮助";
                    this.removeEventListener('click', arguments.callee);
                    document.getElementById('show-more-guide').addEventListener('click', arguments.callee.caller);
                });
            });
            
            // 初始情感状态更新
            gameState.updateEmotionUI();
        });
        
        // 隐藏所有屏幕
        function hideAllScreens() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('level-select').classList.add('hidden');
            document.getElementById('level-1').classList.add('hidden');
            document.getElementById('level-2').classList.add('hidden');
            document.getElementById('level-3').classList.add('hidden');
            document.getElementById('level-4').classList.add('hidden');
            document.getElementById('level-5').classList.add('hidden');
            document.getElementById('ending-screen').classList.add('hidden');
        }
        
        // 关卡一：闻军令
        function initializeLevel1() {
            // 填空游戏初始化 - 简化交互方式
            const wordChoices = document.querySelectorAll('#word-bank-1 .word-choice');
            const blanks = document.querySelectorAll('#level-1 .blank');
            
            // 为每个空白处添加点击高亮和标记
            blanks.forEach(blank => {
                // 添加标记，让用户知道这里需要填词
                blank.textContent = "点击填词";
                blank.classList.add('text-gray-400', 'hover:bg-yellow-50');
                
                blank.addEventListener('click', function() {
                    // 高亮当前选中的空白
                    blanks.forEach(b => b.classList.remove('bg-yellow-100'));
                    this.classList.add('bg-yellow-100');
                    
                    // 创建并显示选词弹窗
                    showWordSelectionPopup(this);
                });
            });
            
            // 创建词语选择弹窗
            function showWordSelectionPopup(blank) {
                // 移除任何已存在的弹窗
                const existingPopup = document.getElementById('word-selection-popup');
                if (existingPopup) existingPopup.remove();
                
                // 创建新弹窗
                const popup = document.createElement('div');
                popup.id = 'word-selection-popup';
                popup.className = 'absolute bg-white dark:bg-gray-700 p-2 rounded-lg shadow-lg z-20 flex flex-wrap gap-1 max-w-xs';
                
                // 计算弹窗位置 - 默认显示在空白下方
                const blankRect = blank.getBoundingClientRect();
                const containerRect = document.getElementById('game-container').getBoundingClientRect();
                
                popup.style.left = `${blankRect.left - containerRect.left}px`;
                popup.style.top = `${blankRect.bottom - containerRect.top + 5}px`;
                
                // 添加词语选项
                wordChoices.forEach(choice => {
                    const wordOption = document.createElement('button');
                    wordOption.className = 'px-2 py-1 bg-amber-200 text-gray-800 rounded hover:bg-amber-300 text-sm';
                    wordOption.textContent = choice.textContent;
                    
                    wordOption.addEventListener('click', function() {
                        blank.textContent = this.textContent;
                        blank.classList.remove('bg-yellow-100', 'text-gray-400');
                        popup.remove();
                    });
                    
                    popup.appendChild(wordOption);
                });
                
                // 添加取消按钮
                const cancelButton = document.createElement('button');
                cancelButton.className = 'px-2 py-1 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 text-sm';
                cancelButton.textContent = '取消';
                cancelButton.addEventListener('click', function() {
                    blank.classList.remove('bg-yellow-100');
                    popup.remove();
                });
                popup.appendChild(cancelButton);
                
                // 添加到容器
                document.getElementById('game-container').appendChild(popup);
                
                // 点击其他地方关闭弹窗
                document.addEventListener('click', function closePopup(e) {
                    if (!popup.contains(e.target) && e.target !== blank) {
                        blank.classList.remove('bg-yellow-100');
                        popup.remove();
                        document.removeEventListener('click', closePopup);
                    }
                });
            }
            
            // 检查填空答案
            document.getElementById('check-fill-blanks').addEventListener('click', function() {
                let correct = 0;
                blanks.forEach(blank => {
                    if (blank.textContent === blank.dataset.answer) {
                        blank.classList.add('bg-green-100');
                        blank.classList.remove('bg-red-100');
                        correct++;
                    } else {
                        blank.classList.add('bg-red-100');
                        blank.classList.remove('bg-green-100');
                    }
                });
                
                const totalBlanks = blanks.length;
                const accuracy = (correct / totalBlanks) * 100;
                
                if (accuracy >= 80) {
                    alert('填空游戏通过！继续下一环节。');
                    document.getElementById('emotion-diary').classList.remove('hidden');
                } else {
                    alert(`正确率: ${accuracy.toFixed(1)}%。需要80%才能通过，请再试一次！`);
                }
            });
            
            // 心理活动题
            document.getElementById('check-concern').addEventListener('click', function() {
                const selectedConcern = document.querySelector('input[name="concern"]:checked');
                if (!selectedConcern) {
                    alert('请选择一个答案！');
                    return;
                }
                
                if (selectedConcern.value === 'D') {
                    alert('正确！木兰同时担忧父亲安危、家族荣誉和家庭生计。');
                    gameState.updateEmotion('determination', 10);
                } else {
                    alert('不完全正确。木兰的担忧是多方面的，包括父亲安危、家族荣誉和家庭生计。');
                }
                
                document.getElementById('emotion-diary').classList.remove('hidden');
            });
            
            // 情感日记提交
            document.getElementById('submit-diary').addEventListener('click', function() {
                const diaryText = document.getElementById('diary-text').value;
                if (diaryText.length < 20) {
                    alert('请至少写20个字的日记内容！');
                    return;
                }
                
                alert('日记提交成功！你很好地表达了木兰的内心世界。');
                
                // 更新情感状态
                gameState.updateEmotion('courage', 15);
                gameState.updateEmotion('determination', 20);
                
                // 显示关卡完成信息
                document.getElementById('level-completion-1').classList.remove('hidden');
                
                // 标记关卡完成
                gameState.completeLevel(1);
            });
        }
        
        // 关卡二：替父从军
        function initializeLevel2() {
            // 1. 木兰心事箱
            const itemCards = document.querySelectorAll('.item-card');
            let selectedItems = [];
            
            itemCards.forEach(card => {
                card.addEventListener('click', function() {
                    if (selectedItems.length >= 3 && !this.classList.contains('selected')) {
                        alert('最多选择3件物品！');
                        return;
                    }
                    
                    this.classList.toggle('selected');
                    this.classList.toggle('bg-amber-200');
                    
                    const itemName = this.querySelector('h4').textContent;
                    const itemId = this.dataset.item;
                    
                    if (this.classList.contains('selected')) {
                        selectedItems.push({name: itemName, id: itemId});
                    } else {
                        selectedItems = selectedItems.filter(item => item.id !== itemId);
                    }
                    
                    updateSelectedItemsDisplay();
                });
            });
            
            function updateSelectedItemsDisplay() {
                document.getElementById('selected-items').classList.toggle('hidden', selectedItems.length === 0);
                document.getElementById('submit-items').classList.toggle('hidden', selectedItems.length < 3);
                
                for (let i = 1; i <= 3; i++) {
                    const itemElement = document.getElementById(`item-${i}`);
                    const itemNameElement = document.getElementById(`item-${i}-name`);
                    
                    if (i <= selectedItems.length) {
                        itemElement.classList.remove('hidden');
                        itemNameElement.textContent = selectedItems[i-1].name;
                    } else {
                        itemElement.classList.add('hidden');
                    }
                }
            }
            
            // 提交物品分析
            document.getElementById('submit-items').addEventListener('click', function() {
                const textareas = document.querySelectorAll('#selected-items textarea');
                let allFilled = true;
                let requiredLength = 30; // 默认字数要求(将军难度)
                
                // 根据难度设置不同的字数要求
                if (gameState.difficulty === 'easy') {
                    requiredLength = 10; // 小卒难度
                } else if (gameState.difficulty === 'medium') {
                    requiredLength = 20; // 百夫长难度
                }
                
                textareas.forEach(textarea => {
                    if (textarea.value.length < requiredLength) {
                        allFilled = false;
                    }
                });
                
                if (!allFilled) {
                    alert(`请为每件物品至少写${requiredLength}个字的情感分析！`);
                    return;
                }
                
                // 更新情感状态并显示离别场景
                gameState.updateEmotion('courage', 10);
                gameState.updateEmotion('determination', 15);
                alert('分析提交成功！你很好地解读了木兰携带物品背后的情感含义。');
                document.getElementById('farewell-scene').classList.remove('hidden');
            });
            
            // 2. 离别场景选择
            document.getElementById('submit-farewell').addEventListener('click', function() {
                const fatherChoice = document.querySelector('input[name="farewell-father"]:checked');
                const motherChoice = document.querySelector('input[name="farewell-mother"]:checked');
                
                if (!fatherChoice || !motherChoice) {
                    alert('请完成所有选择！');
                    return;
                }
                
                // 根据选择更新情感状态
                updateEmotionsBasedOnChoices(fatherChoice.value, motherChoice.value);
                
                // 显示装备准备挑战
                document.getElementById('equipment-challenge').classList.remove('hidden');
                startMemoryChallenge();
            });
            
            function updateEmotionsBasedOnChoices(fatherChoice, motherChoice) {
                // 与父亲告别的情感影响
                if (fatherChoice === 'A') { // 郑重承诺
                    gameState.updateEmotion('determination', 15);
                    gameState.updateEmotion('fear', -5);
                } else if (fatherChoice === 'B') { // 沉默相对
                    gameState.updateEmotion('courage', 10);
                    gameState.updateEmotion('fear', -5);
                } else if (fatherChoice === 'C') { // 跪拜告别
                    gameState.updateEmotion('homesick', 15);
                }
                
                // 与母亲告别的情感影响
                if (motherChoice === 'A') { // 抱别安慰
                    gameState.updateEmotion('courage', 10);
                    gameState.updateEmotion('homesick', 10);
                } else if (motherChoice === 'B') { // 转身离去
                    gameState.updateEmotion('fear', 10);
                    gameState.updateEmotion('determination', 5);
                } else if (motherChoice === 'C') { // 承诺写信
                    gameState.updateEmotion('homesick', 5);
                    gameState.updateEmotion('determination', 10);
                }
            }
            
            // 3. 装备准备挑战
            function startMemoryChallenge() {
                let timeLeft = 10;
                const timerBar = document.getElementById('timer-bar');
                const timerText = document.getElementById('memory-timer');
                
                const timer = setInterval(() => {
                    timeLeft--;
                    timerText.textContent = `记忆时间: ${timeLeft}秒`;
                    timerBar.style.width = `${timeLeft * 10}%`;
                    
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        document.querySelector('.memory-phase').classList.add('hidden');
                        document.getElementById('quiz-phase').classList.remove('hidden');
                    }
                }, 1000);
            }
            
            // 检查装备答案
            document.getElementById('check-equipment').addEventListener('click', function() {
                const horseLocation = document.getElementById('horse-location').value;
                const saddleLocation = document.getElementById('saddle-location').value;
                const bridleLocation = document.getElementById('bridle-location').value;
                const whipLocation = document.getElementById('whip-location').value;
                
                if (!horseLocation || !saddleLocation || !bridleLocation || !whipLocation) {
                    alert('请完成所有选择！');
                    return;
                }
                
                const answers = {
                    horse: 'east',    // 东市买骏马
                    saddle: 'west',   // 西市买鞍鞯
                    bridle: 'south',  // 南市买辔头
                    whip: 'north'     // 北市买长鞭
                };
                
                let correct = 0;
                if (horseLocation === answers.horse) correct++;
                if (saddleLocation === answers.saddle) correct++;
                if (bridleLocation === answers.bridle) correct++;
                if (whipLocation === answers.whip) correct++;
                
                const accuracy = (correct / 4) * 100;
                
                if (accuracy >= 75) {
                    // 更新情感状态
                    gameState.updateEmotion('courage', 10);
                    gameState.updateEmotion('determination', 10);
                    
                    // 显示完成信息
                    updateCompletionInfo();
                    
                    alert(`正确率：${accuracy}%。准备工作完成！木兰已做好从军准备。`);
                } else {
                    alert(`正确率：${accuracy}%。请再次尝试，记住《木兰诗》中的描述：东市买骏马，西市买鞍鞯，南市买辔头，北市买长鞭。`);
                    
                    // 重置选择并重新开始记忆挑战
                    document.querySelectorAll('#quiz-phase select').forEach(select => {
                        select.value = "";
                    });
                    
                    document.getElementById('quiz-phase').classList.add('hidden');
                    document.querySelector('.memory-phase').classList.remove('hidden');
                    startMemoryChallenge();
                }
            });
            
            // 关卡完成信息
            function updateCompletionInfo() {
                // 填充情感变化
                const emotionChanges = document.getElementById('emotion-changes');
                emotionChanges.innerHTML = `
                    <div>勇气 +${30}%</div>
                    <div>决心 +${40}%</div>
                    <div>思乡 +${15}%</div>
                    <div>恐惧 ${-5}%</div>
                `;
                
                // 显示完成信息
                document.getElementById('level-completion-2').classList.remove('hidden');
                
                // 标记关卡完成
                gameState.completeLevel(2);
            }
        }
        
        // 关卡三：军营生存
        function initializeLevel3() {
            // 1. 篝火夜话：心灵之镜
            let currentScene = 'homesick'; // 当前场景：乡愁之夜
            
            // 场景回应选择
            document.querySelectorAll('input[name^="response-"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const scene = this.name.split('-')[1];
                    const selectedValue = this.value;
                    
                    // 显示内心活动选项
                    showInnerThoughts(scene, selectedValue);
                });
            });
            
            // 显示内心活动选择项
            function showInnerThoughts(scene, response) {
                const thoughtsContainer = document.getElementById(`inner-thoughts-${scene}`);
                thoughtsContainer.classList.remove('hidden');
                
                let thoughtsHTML = '';
                
                if (scene === 'homesick') {
                    if (response === 'A') { // "军中即是家，战友如亲人。"
                        thoughtsHTML = `
                        <label class="flex items-center p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                            <input type="radio" name="thought-homesick" value="A1" class="mr-2">
                            <div>
                                <p class="font-bold">说谎已成习惯，可我真的好想家...</p>
                                <p class="text-sm text-gray-500">显示悲伤情绪</p>
                            </div>
                        </label>
                        <label class="flex items-center p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                            <input type="radio" name="thought-homesick" value="A2" class="mr-2">
                            <div>
                                <p class="font-bold">保持距离是最安全的策略，但如此孤独...</p>
                                <p class="text-sm text-gray-500">显示理智分析</p>
                            </div>
                        </label>
                        `;
                    } else if (response === 'B') { // "家中有老父，确实日夜挂念。"
                        thoughtsHTML = `
                        <label class="flex items-center p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                            <input type="radio" name="thought-homesick" value="B1" class="mr-2">
                            <div>
                                <p class="font-bold">至少这不全是谎言，只是没说明我是女儿不是儿子...</p>
                                <p class="text-sm text-gray-500">显示复杂心理</p>
                            </div>
                        </label>
                        <label class="flex items-center p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                            <input type="radio" name="thought-homesick" value="B2" class="mr-2">
                            <div>
                                <p class="font-bold">说出了真心话，希望这不会引起怀疑。</p>
                                <p class="text-sm text-gray-500">显示担忧</p>
                            </div>
                        </label>
                        `;
                    } else if (response === 'C') { // "男儿志在四方，何须念家。"
                        thoughtsHTML = `
                        <label class="flex items-center p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                            <input type="radio" name="thought-homesick" value="C1" class="mr-2">
                            <div>
                                <p class="font-bold">说这种违心话真是痛苦，我日夜思念家人...</p>
                                <p class="text-sm text-gray-500">显示内心矛盾</p>
                            </div>
                        </label>
                        <label class="flex items-center p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                            <input type="radio" name="thought-homesick" value="C2" class="mr-2">
                            <div>
                                <p class="font-bold">必须坚强，不能露出破绽，为家人坚持下去！</p>
                                <p class="text-sm text-gray-500">显示决心</p>
                            </div>
                        </label>
                        `;
                    }
                } else if (scene === 'romance') {
                    // 类似实现其他场景的内心活动选项...
                    if (response === 'A') {
                        thoughtsHTML = `
                        <label class="flex items-center p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                            <input type="radio" name="thought-romance" value="A1" class="mr-2">
                            <div>
                                <p class="font-bold">永远不能让他们知道，我对爱情的理解与他们不同...</p>
                                <p class="text-sm text-gray-500">显示隔阂感</p>
                            </div>
                        </label>
                        `;
                    } else if (response === 'B') {
                        thoughtsHTML = `
                        <label class="flex items-center p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                            <input type="radio" name="thought-romance" value="B1" class="mr-2">
                            <div>
                                <p class="font-bold">编造的故事越多，越容易暴露...但这是必要的伪装。</p>
                                <p class="text-sm text-gray-500">显示担忧</p>
                            </div>
                        </label>
                        `;
                    } else if (response === 'C') {
                        thoughtsHTML = `
                        <label class="flex items-center p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                            <input type="radio" name="thought-romance" value="C1" class="mr-2">
                            <div>
                                <p class="font-bold">转移话题是最安全的方式，不能让自己成为焦点。</p>
                                <p class="text-sm text-gray-500">显示警觉</p>
                            </div>
                        </label>
                        `;
                    }
                } else if (scene === 'war') {
                    // 实现战争反思场景的内心活动选项...
                    if (response === 'A') {
                        thoughtsHTML = `
                        <label class="flex items-center p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                            <input type="radio" name="thought-war" value="A1" class="mr-2">
                            <div>
                                <p class="font-bold">我也为保家卫国而来，但看到这么多死亡，内心却充满疑问...</p>
                                <p class="text-sm text-gray-500">显示矛盾</p>
                            </div>
                        </label>
                        `;
                    } else if (response === 'B') {
                        thoughtsHTML = `
                        <label class="flex items-center p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                            <input type="radio" name="thought-war" value="B1" class="mr-2">
                            <div>
                                <p class="font-bold">作为女性，我更理解和平的珍贵，但不能说出来...</p>
                                <p class="text-sm text-gray-500">显示性别视角</p>
                            </div>
                        </label>
                        `;
                    } else if (response === 'C') {
                        thoughtsHTML = `
                        <label class="flex items-center p-2 rounded hover:bg-amber-200 dark:hover:bg-gray-600">
                            <input type="radio" name="thought-war" value="C1" class="mr-2">
                            <div>
                                <p class="font-bold">我内心有太多想法，但都不能说。这样的伪装太痛苦了。</p>
                                <p class="text-sm text-gray-500">显示压抑</p>
                            </div>
                        </label>
                        `;
                    }
                }
                
                thoughtsContainer.querySelector('.space-y-2').innerHTML = thoughtsHTML;
            }
            
            // 篝火夜话继续按钮
            document.getElementById('submit-campfire').addEventListener('click', function() {
                const responseSelected = document.querySelector(`input[name="response-${currentScene}"]:checked`);
                const thoughtSelected = document.querySelector(`input[name="thought-${currentScene}"]:checked`);
                
                if (!responseSelected) {
                    alert('请选择一个回应！');
                    return;
                }
                
                if (!thoughtSelected && document.getElementById(`inner-thoughts-${currentScene}`).classList.contains('hidden') === false) {
                    alert('请选择一个内心活动！');
                    return;
                }
                
                // 根据选择更新情感状态
                updateEmotionsBasedOnCampfireChoices(currentScene, responseSelected.value, thoughtSelected ? thoughtSelected.value : null);
                
                // 进入下一个场景或完成篝火夜话
                if (currentScene === 'homesick') {
                    currentScene = 'romance';
                    document.getElementById('scene-romance').classList.remove('hidden');
                    this.textContent = '继续对话';
                } else if (currentScene === 'romance') {
                    currentScene = 'war';
                    document.getElementById('scene-war').classList.remove('hidden');
                    this.textContent = '完成对话';
                } else if (currentScene === 'war') {
                    // 篝火夜话完成，进入骑术练习
                    document.getElementById('riding-practice').classList.remove('hidden');
                    this.classList.add('hidden');
                    initializeRidingPractice();
                }
            });
            
            function updateEmotionsBasedOnCampfireChoices(scene, response, thought) {
                // 根据场景和选择更新情感状态
                if (scene === 'homesick') {
                    if (response === 'A') { // 安全但疏远
                        gameState.updateEmotion('determination', 5);
                        gameState.updateEmotion('fear', -5);
                        
                        if (thought === 'A1') gameState.updateEmotion('homesick', 15);
                        if (thought === 'A2') gameState.updateEmotion('courage', 10);
                    } else if (response === 'B') { // 真实但克制
                        gameState.updateEmotion('homesick', 10);
                        gameState.updateEmotion('courage', 5);
                        
                        if (thought === 'B1') gameState.updateEmotion('fear', 5);
                        if (thought === 'B2') gameState.updateEmotion('fear', 10);
                    } else if (response === 'C') { // 符合角色但违心
                        gameState.updateEmotion('fear', -10);
                        gameState.updateEmotion('determination', 10);
                        
                        if (thought === 'C1') gameState.updateEmotion('homesick', 15);
                        if (thought === 'C2') gameState.updateEmotion('courage', 15);
                    }
                } else if (scene === 'romance') {
                    // 类似实现其他场景的情感更新...
                    if (response === 'A') {
                        gameState.updateEmotion('determination', 10);
                        if (thought === 'A1') gameState.updateEmotion('fear', 5);
                    } else if (response === 'B') {
                        gameState.updateEmotion('courage', 5);
                        if (thought === 'B1') gameState.updateEmotion('fear', 10);
                    } else if (response === 'C') {
                        gameState.updateEmotion('courage', 10);
                        if (thought === 'C1') gameState.updateEmotion('determination', 5);
                    }
                } else if (scene === 'war') {
                    if (response === 'A') {
                        gameState.updateEmotion('determination', 10);
                        if (thought === 'A1') gameState.updateEmotion('courage', 5);
                    } else if (response === 'B') {
                        gameState.updateEmotion('courage', 15);
                        if (thought === 'B1') gameState.updateEmotion('fear', -5);
                    } else if (response === 'C') {
                        gameState.updateEmotion('fear', 5);
                        if (thought === 'C1') gameState.updateEmotion('determination', 5);
                    }
                }
            }
            
            // 2. 骑术练习：军事与文化融合
            function initializeRidingPractice() {
                let collectedCount = 0;
                const totalKnowledge = 5;
                
                // 知识卡片点击展开
                document.querySelectorAll('.knowledge-card').forEach(card => {
                    card.addEventListener('click', function() {
                        const content = this.querySelector('.knowledge-content');
                        const quiz = this.querySelector('.knowledge-quiz');
                        
                        if (content.classList.contains('hidden')) {
                            content.classList.remove('hidden');
                            setTimeout(() => {
                                quiz.classList.remove('hidden');
                            }, 1000);
                        }
                    });
                });
                
                // 检查答案按钮
                document.querySelectorAll('.check-answer').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const quizName = this.dataset.quiz;
                        const correctAnswer = this.dataset.answer;
                        const selectedAnswer = document.querySelector(`input[name="quiz-${quizName}"]:checked`);
                        
                        if (!selectedAnswer) {
                            alert('请选择一个答案！');
                            return;
                        }
                        
                        if (selectedAnswer.value === correctAnswer) {
                            alert('回答正确！');
                            
                            // 更新已收集知识点
                            collectedCount++;
                            document.getElementById('collected-knowledge').textContent = `${collectedCount}/${totalKnowledge}`;
                            document.getElementById('knowledge-progress').style.width = `${(collectedCount / totalKnowledge) * 100}%`;
                            
                            // 禁用已完成的卡片
                            this.closest('.knowledge-card').classList.add('opacity-50');
                            this.closest('.knowledge-card').style.pointerEvents = 'none';
                            
                            // 根据知识类型更新情感状态
                            if (quizName === 'tactical') {
                                gameState.updateEmotion('determination', 5);
                                gameState.updateEmotion('courage', 5);
                            } else if (quizName === 'vocab') {
                                gameState.updateEmotion('determination', 10);
                            } else if (quizName === 'weapon') {
                                gameState.updateEmotion('courage', 10);
                                gameState.updateEmotion('fear', -5);
                            } else if (quizName === 'history') {
                                gameState.updateEmotion('determination', 5);
                            } else if (quizName === 'poetry') {
                                gameState.updateEmotion('homesick', 10);
                                gameState.updateEmotion('courage', 5);
                            }
                            
                            // 检查是否所有知识点都已收集
                            if (collectedCount >= totalKnowledge) {
                                document.getElementById('finish-riding').classList.remove('hidden');
                            }
                        } else {
                            alert('回答错误，请再试一次！');
                        }
                    });
                });
                
                // 完成训练按钮
                document.getElementById('finish-riding').addEventListener('click', function() {
                    // 进入战友关系网络环节
                    document.getElementById('comrade-network').classList.remove('hidden');
                    this.classList.add('hidden');
                    initializeComradeNetwork();
                });
            }
            
            // 3. 战友关系网络
            function initializeComradeNetwork() {
                let interactionCount = 0;
                const maxInteractions = 3;
                
                // 战友互动按钮
                document.querySelectorAll('.interact-comrade').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const comrade = this.dataset.comrade;
                        const action = this.dataset.action;
                        
                        // 限制互动次数
                        interactionCount++;
                        if (interactionCount >= maxInteractions) {
                            document.getElementById('finish-social').classList.remove('hidden');
                            // 禁用所有互动按钮
                            document.querySelectorAll('.interact-comrade').forEach(b => {
                                b.disabled = true;
                                b.classList.add('opacity-50');
                            });
                        }
                        
                        // 显示互动结果
                        showInteractionResult(comrade, action);
                        
                        // 更新战友关系
                        updateComradeRelation(comrade, action);
                    });
                });
                
                function showInteractionResult(comrade, action) {
                    const resultContainer = document.getElementById('interaction-result');
                    resultContainer.classList.remove('hidden');
                    
                    let resultHTML = '';
                    let emotionChanges = '';
                    
                    if (comrade === 'zhang') { // 老兵张顺
                        if (action === 'train') {
                            resultHTML = `
                            <h4 class="font-bold mb-2">与张顺一起训练</h4>
                            <p>张顺对你的刻苦训练表示赞赏："不错，有点军人样子了。继续努力！"</p>
                            `;
                            emotionChanges = '决心 +10，勇气 +5';
                            gameState.updateEmotion('determination', 10);
                            gameState.updateEmotion('courage', 5);
                        } else if (action === 'advice') {
                            resultHTML = `
                            <h4 class="font-bold mb-2">向张顺请教战术</h4>
                            <p>张顺分享了丰富的战场经验："记住，活下来的第一要务是观察地形。"</p>
                            `;
                            emotionChanges = '恐惧 -10，决心 +5';
                            gameState.updateEmotion('fear', -10);
                            gameState.updateEmotion('determination', 5);
                        }
                    } else if (comrade === 'li') { // 热情新兵小李
                        if (action === 'chat') {
                            resultHTML = `
                            <h4 class="font-bold mb-2">与小李闲聊家乡</h4>
                            <p>小李热情地讲述家乡风光，同时询问你的家庭情况。你小心地分享一些真实但不会暴露身份的细节。</p>
                            `;
                            emotionChanges = '思乡 +15，恐惧 +5';
                            gameState.updateEmotion('homesick', 15);
                            gameState.updateEmotion('fear', 5);
                        } else if (action === 'avoid') {
                            resultHTML = `
                            <h4 class="font-bold mb-2">委婉回避小李</h4>
                            <p>你以训练忙为由减少与小李的互动。他看起来有些失落，但没有多问。</p>
                            `;
                            emotionChanges = '思乡 -5，决心 +10';
                            gameState.updateEmotion('homesick', -5);
                            gameState.updateEmotion('determination', 10);
                        }
                    } else if (comrade === 'wang') { // 观察敏锐的副官王伟
                        if (action === 'report') {
                            resultHTML = `
                            <h4 class="font-bold mb-2">向王伟主动报告</h4>
                            <p>你主动向王伟汇报训练情况。他审视地看着你："很好，但我总觉得你有些不同。"</p>
                            `;
                            emotionChanges = '恐惧 +15，勇气 +5';
                            gameState.updateEmotion('fear', 15);
                            gameState.updateEmotion('courage', 5);
                        } else if (action === 'distance') {
                            resultHTML = `
                            <h4 class="font-bold mb-2">与王伟保持距离</h4>
                            <p>你尽量避开王伟的视线，只在必要时交流。他似乎注意到了这一点，时不时投来怀疑的目光。</p>
                            `;
                            emotionChanges = '恐惧 +10，决心 +10';
                            gameState.updateEmotion('fear', 10);
                            gameState.updateEmotion('determination', 10);
                        }
                    }
                    
                    resultHTML += `<p class="text-sm mt-2">情感变化：${emotionChanges}</p>`;
                    resultContainer.innerHTML = resultHTML;
                }
                
                function updateComradeRelation(comrade, action) {
                    // 更新战友关系进度条
                    const comradeCards = document.querySelectorAll('.comrade-card');
                    comradeCards.forEach(card => {
                        if (card.querySelector('h4').textContent.toLowerCase().includes(comrade)) {
                            const relationBar = card.querySelector('.comrade-relation');
                            let currentWidth = parseInt(relationBar.style.width);
                            
                            // 根据行动调整关系
                            if (comrade === 'zhang') {
                                if (action === 'train') currentWidth += 15;
                                if (action === 'advice') currentWidth += 10;
                            } else if (comrade === 'li') {
                                if (action === 'chat') currentWidth += 20;
                                if (action === 'avoid') currentWidth -= 10;
                            } else if (comrade === 'wang') {
                                if (action === 'report') currentWidth += 5;
                                if (action === 'distance') currentWidth -= 5;
                            }
                            
                            // 确保范围在0-100之间
                            currentWidth = Math.max(0, Math.min(100, currentWidth));
                            relationBar.style.width = currentWidth + '%';
                        }
                    });
                }
                
                // 完成社交按钮
                document.getElementById('finish-social').addEventListener('click', function() {
                    // 完成关卡三
                    completeLevel3();
                });
            }
            
            // 关卡完成函数
            function completeLevel3() {
                // 更新情感变化显示
                const emotionChanges = document.getElementById('emotion-changes-3');
                emotionChanges.innerHTML = `
                    <div>勇气 +${15}%</div>
                    <div>思乡 +${25}%</div>
                    <div>决心 +${25}%</div>
                    <div>恐惧 ${-10}%</div>
                `;
                
                // 显示关卡完成信息
                document.getElementById('level-completion-3').classList.remove('hidden');
                
                // 标记关卡完成
                gameState.completeLevel(3);
            }
        }
        
        // 关卡四：沙场点兵
        function initializeLevel4() {
            // 1. 战功诗句记忆配对
            let selectedFirstVerse = null;
            let selectedSecondVerse = null;
            let matchedPairs = 0;
            const totalPairs = 4;
            
            // 诗句点击事件
            document.querySelectorAll('.verse-item').forEach(item => {
                item.addEventListener('click', function() {
                    // 已匹配的诗句不能再次选择
                    if (this.classList.contains('matched')) {
                        return;
                    }
                    
                    // 选择第一句
                    if (!selectedFirstVerse) {
                        selectedFirstVerse = this;
                        this.classList.add('bg-amber-200', 'dark:bg-amber-800');
                        document.getElementById('first-verse').textContent = this.textContent.trim();
                        return;
                    }
                    
                    // 避免重复选择同一句
                    if (this === selectedFirstVerse) {
                        return;
                    }
                    
                    // 选择第二句
                    selectedSecondVerse = this;
                    this.classList.add('bg-amber-200', 'dark:bg-amber-800');
                    document.getElementById('second-verse').textContent = this.textContent.trim();
                    document.getElementById('second-verse').classList.remove('hidden');
                    
                    // 检查是否匹配
                    setTimeout(() => {
                        checkMatch();
                    }, 500);
                });
            });
            
            // 检查诗句匹配
            function checkMatch() {
                const firstVerseId = selectedFirstVerse.dataset.verse;
                const secondVerseId = selectedSecondVerse.dataset.verse;
                
                if (firstVerseId === secondVerseId) {
                    // 匹配成功
                    selectedFirstVerse.classList.add('matched', 'bg-green-100', 'dark:bg-green-800');
                    selectedSecondVerse.classList.add('matched', 'bg-green-100', 'dark:bg-green-800');
                    selectedFirstVerse.classList.remove('bg-amber-200', 'dark:bg-amber-800');
                    selectedSecondVerse.classList.remove('bg-amber-200', 'dark:bg-amber-800');
                    
                    // 添加到已匹配列表
                    const matchedList = document.getElementById('matched-list');
                    matchedList.innerHTML += `
                        <div class="bg-green-100 dark:bg-green-800 p-2 rounded-lg">
                            ${selectedFirstVerse.textContent.trim()} - ${selectedSecondVerse.textContent.trim()}
                        </div>
                    `;
                    
                    // 更新匹配计数
                    matchedPairs++;
                    document.getElementById('match-count').textContent = matchedPairs;
                    
                    // 更新情感状态
                    gameState.updateEmotion('courage', 5);
                    gameState.updateEmotion('determination', 5);
                    
                    // 检查是否所有都匹配完成
                    if (matchedPairs >= totalPairs) {
                        setTimeout(() => {
                            alert('恭喜！你已完成所有诗句配对。');
                            // 显示巾帼英雄卡片收集
                            document.getElementById('heroines-collection').classList.remove('hidden');
                            initializeHeroineCards();
                        }, 500);
                    }
                } else {
                    // 匹配失败
                    selectedFirstVerse.classList.remove('bg-amber-200', 'dark:bg-amber-800');
                    selectedSecondVerse.classList.remove('bg-amber-200', 'dark:bg-amber-800');
                }
                
                // 重置选择
                selectedFirstVerse = null;
                selectedSecondVerse = null;
                document.getElementById('first-verse').textContent = '请选择第一句...';
                document.getElementById('second-verse').textContent = '请选择第二句...';
                document.getElementById('second-verse').classList.add('hidden');
            }
            
            // 2. 巾帼英雄卡片收集
            function initializeHeroineCards() {
                let completedChallenges = 0;
                const totalChallenges = 3;
                
                // 标签切换
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const heroine = this.dataset.heroine;
                        const tab = this.dataset.tab;
                        
                        // 移除同一英雄所有标签的激活状态
                        document.querySelectorAll(`.tab-btn[data-heroine="${heroine}"]`).forEach(b => {
                            b.classList.remove('active', 'bg-amber-200');
                        });
                        
                        // 激活当前标签
                        this.classList.add('active', 'bg-amber-200');
                        
                        // 更新内容显示
                        const heroineCard = this.closest('.heroine-card');
                        heroineCard.querySelectorAll('.heroine-tab').forEach(t => {
                            t.classList.add('hidden');
                        });
                        heroineCard.querySelector(`.heroine-tab[data-tab="${tab}"]`).classList.remove('hidden');
                    });
                });
                
                // 挑战按钮
                document.querySelectorAll('.heroine-challenge').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const heroine = this.dataset.heroine;
                        startHeroineChallenge(heroine, this);
                    });
                });
                
                // 开始英雄挑战
                function startHeroineChallenge(heroine, button) {
                    let challengeTitle = "";
                    let challengeDescription = "";
                    let challengeHTML = "";
                    
                    // 根据不同英雄设置不同挑战
                    if (heroine === 'muguiying') {
                        challengeTitle = "神箭手挑战";
                        challengeDescription = "点击移动的靶子，测试你的反应速度和精准度。";
                        challengeHTML = createArcheryChallenge();
                    } else if (heroine === 'lianghongyu') {
                        challengeTitle = "擂鼓助威挑战";
                        challengeDescription = "按照提示点击鼓面，创造振奋人心的节奏。";
                        challengeHTML = createDrumChallenge();
                    } else if (heroine === 'qinliangyu') {
                        challengeTitle = "兵力部署挑战";
                        challengeDescription = "合理分配有限兵力守卫多个位置，抵挡敌军进攻。";
                        challengeHTML = createDeploymentChallenge();
                    }
                    
                    // 创建挑战弹窗
                    const modal = document.createElement('div');
                    modal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
                    modal.innerHTML = `
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-4 w-11/12 max-w-md">
                            <h3 class="text-lg font-bold mb-2">${challengeTitle}</h3>
                            <p class="text-sm mb-4">${challengeDescription}</p>
                            <div class="challenge-content mb-4">
                                ${challengeHTML}
                            </div>
                            <div class="flex justify-between">
                                <button class="close-challenge px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600">关闭</button>
                                <button class="complete-challenge px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 hidden">完成挑战</button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    // 关闭挑战
                    modal.querySelector('.close-challenge').addEventListener('click', function() {
                        modal.remove();
                    });
                    
                    // 完成挑战
                    modal.querySelector('.complete-challenge').addEventListener('click', function() {
                        // 标记按钮为已完成
                        button.textContent = "挑战完成";
                        button.disabled = true;
                        button.classList.add('bg-green-600');
                        
                        // 根据英雄类型更新情感状态
                        if (heroine === 'muguiying') {
                            gameState.updateEmotion('courage', 10);
                            gameState.updateEmotion('determination', 5);
                        } else if (heroine === 'lianghongyu') {
                            gameState.updateEmotion('courage', 5);
                            gameState.updateEmotion('fear', -10);
                        } else if (heroine === 'qinliangyu') {
                            gameState.updateEmotion('determination', 15);
                        }
                        
                        // 关闭弹窗
                        modal.remove();
                        
                        // 更新完成挑战计数
                        completedChallenges++;
                        if (completedChallenges >= totalChallenges) {
                            // 显示历史映照环节
                            document.getElementById('historical-reflection').classList.remove('hidden');
                            initializeHistoricalReflection();
                        }
                    });
                    
                    // 初始化具体挑战内容
                    if (heroine === 'muguiying') {
                        initializeArcheryChallenge(modal);
                    } else if (heroine === 'lianghongyu') {
                        initializeDrumChallenge(modal);
                    } else if (heroine === 'qinliangyu') {
                        initializeDeploymentChallenge(modal);
                    }
                }
                
                // 创建射箭挑战HTML
                function createArcheryChallenge() {
                    return `
                        <div id="archery-game" class="h-40 bg-amber-100 dark:bg-gray-700 relative rounded-lg overflow-hidden">
                            <div id="archery-target" class="absolute w-10 h-10 bg-red-600 rounded-full flex items-center justify-center text-white cursor-pointer" style="top: 20px; left: 50%;">
                                🎯
                            </div>
                            <div id="archery-score" class="absolute top-2 right-2 font-bold">得分: 0/5</div>
                        </div>
                    `;
                }
                
                // 初始化射箭挑战
                function initializeArcheryChallenge(modal) {
                    const target = modal.querySelector('#archery-target');
                    const scoreDisplay = modal.querySelector('#archery-score');
                    const completeBtn = modal.querySelector('.complete-challenge');
                    let score = 0;
                    const maxScore = 5;
                    
                    // 随机移动靶子
                    function moveTarget() {
                        const gameArea = modal.querySelector('#archery-game');
                        const maxX = gameArea.offsetWidth - target.offsetWidth;
                        const maxY = gameArea.offsetHeight - target.offsetHeight;
                        
                        const randomX = Math.floor(Math.random() * maxX);
                        const randomY = Math.floor(Math.random() * maxY);
                        
                        target.style.left = `${randomX}px`;
                        target.style.top = `${randomY}px`;
                    }
                    
                    // 初始移动
                    moveTarget();
                    
                    // 点击靶子得分
                    target.addEventListener('click', function() {
                        score++;
                        scoreDisplay.textContent = `得分: ${score}/${maxScore}`;
                        
                        if (score >= maxScore) {
                            completeBtn.classList.remove('hidden');
                        } else {
                            moveTarget();
                        }
                    });
                    
                    // 定时移动靶子，增加难度
                    const moveInterval = setInterval(() => {
                        if (score < maxScore) {
                            moveTarget();
                        } else {
                            clearInterval(moveInterval);
                        }
                    }, 1500);
                    
                    // 关闭弹窗时清除定时器
                    modal.querySelector('.close-challenge').addEventListener('click', function() {
                        clearInterval(moveInterval);
                    });
                }
                
                // 创建击鼓挑战HTML
                function createDrumChallenge() {
                    return `
                        <div id="drum-game" class="h-40 bg-amber-100 dark:bg-gray-700 relative rounded-lg overflow-hidden flex items-center justify-center">
                            <div id="drum" class="w-24 h-24 bg-amber-700 rounded-full flex items-center justify-center text-3xl cursor-pointer">
                                🥁
                            </div>
                            <div id="drum-pattern" class="absolute bottom-2 left-0 right-0 text-center">
                                点击跟随节奏: <span id="drum-sequence">⬤ ⬤ ⬤ ⬤</span>
                            </div>
                            <div id="drum-score" class="absolute top-2 right-2 font-bold">进度: 0/3</div>
                        </div>
                    `;
                }
                
                // 初始化击鼓挑战
                function initializeDrumChallenge(modal) {
                    const drum = modal.querySelector('#drum');
                    const sequenceDisplay = modal.querySelector('#drum-sequence');
                    const scoreDisplay = modal.querySelector('#drum-score');
                    const completeBtn = modal.querySelector('.complete-challenge');
                    
                    let currentPattern = 0;
                    let currentStep = 0;
                    let score = 0;
                    const maxScore = 3;
                    
                    const patterns = [
                        [500, 500, 1000, 500], // 短-短-长-短
                        [300, 300, 300, 1000], // 短-短-短-长
                        [1000, 300, 300, 1000]  // 长-短-短-长
                    ];
                    
                    // 显示当前节奏
                    function showPattern() {
                        const pattern = patterns[currentPattern];
                        let display = '';
                        
                        for (let i = 0; i < pattern.length; i++) {
                            if (pattern[i] >= 1000) {
                                display += '⬤ '; // 长音
                            } else {
                                display += '• '; // 短音
                            }
                        }
                        
                        sequenceDisplay.textContent = display.trim();
                    }
                    
                    // 初始显示
                    showPattern();
                    
                    // 点击鼓
                    drum.addEventListener('click', function() {
                        const pattern = patterns[currentPattern];
                        
                        // 视觉反馈
                        drum.classList.add('scale-95', 'bg-amber-800');
                        setTimeout(() => {
                            drum.classList.remove('scale-95', 'bg-amber-800');
                        }, 100);
                        
                        // 检查节奏
                        if (currentStep < pattern.length) {
                            currentStep++;
                            
                            // 完成一组节奏
                            if (currentStep >= pattern.length) {
                                currentStep = 0;
                                currentPattern++;
                                score++;
                                scoreDisplay.textContent = `进度: ${score}/${maxScore}`;
                                
                                if (currentPattern >= patterns.length) {
                                    currentPattern = 0;
                                }
                                
                                if (score >= maxScore) {
                                    completeBtn.classList.remove('hidden');
                                } else {
                                    showPattern();
                                }
                            }
                        }
                    });
                }
                
                // 创建兵力部署挑战HTML
                function createDeploymentChallenge() {
                    return `
                        <div id="deployment-game" class="h-48 bg-amber-100 dark:bg-gray-700 relative rounded-lg p-2">
                            <div class="grid grid-cols-3 gap-2 h-full">
                                <div class="deploy-zone bg-amber-200 dark:bg-gray-600 rounded flex flex-col items-center justify-center p-1" data-importance="high">
                                    <div>前线要塞</div>
                                    <div class="text-xs">重要性: 高</div>
                                    <div class="troop-count mt-2">兵力: <span>0</span>/5</div>
                                    <button class="deploy-btn mt-1 px-2 py-1 bg-amber-700 text-white rounded text-xs">部署</button>
                                </div>
                                <div class="deploy-zone bg-amber-200 dark:bg-gray-600 rounded flex flex-col items-center justify-center p-1" data-importance="medium">
                                    <div>中心城镇</div>
                                    <div class="text-xs">重要性: 中</div>
                                    <div class="troop-count mt-2">兵力: <span>0</span>/3</div>
                                    <button class="deploy-btn mt-1 px-2 py-1 bg-amber-700 text-white rounded text-xs">部署</button>
                                </div>
                                <div class="deploy-zone bg-amber-200 dark:bg-gray-600 rounded flex flex-col items-center justify-center p-1" data-importance="low">
                                    <div>后方村庄</div>
                                    <div class="text-xs">重要性: 低</div>
                                    <div class="troop-count mt-2">兵力: <span>0</span>/2</div>
                                    <button class="deploy-btn mt-1 px-2 py-1 bg-amber-700 text-white rounded text-xs">部署</button>
                                </div>
                            </div>
                            <div class="mt-2 text-center">
                                <div>可用兵力: <span id="available-troops">10</span></div>
                            </div>
                        </div>
                    `;
                }
                
                // 初始化兵力部署挑战
                function initializeDeploymentChallenge(modal) {
                    const deployBtns = modal.querySelectorAll('.deploy-btn');
                    const availableTroopsDisplay = modal.querySelector('#available-troops');
                    const completeBtn = modal.querySelector('.complete-challenge');
                    
                    let availableTroops = 10;
                    const zones = [
                        { importance: 'high', min: 4, current: 0, max: 5 },
                        { importance: 'medium', min: 2, current: 0, max: 3 },
                        { importance: 'low', min: 1, current: 0, max: 2 }
                    ];
                    
                    // 部署按钮
                    deployBtns.forEach((btn, index) => {
                        btn.addEventListener('click', function() {
                            if (availableTroops > 0 && zones[index].current < zones[index].max) {
                                zones[index].current++;
                                availableTroops--;
                                
                                // 更新显示
                                this.parentElement.querySelector('.troop-count span').textContent = zones[index].current;
                                availableTroopsDisplay.textContent = availableTroops;
                                
                                // 检查是否达到完成条件
                                checkDeployment();
                            }
                        });
                    });
                    
                    // 检查部署是否合理
                    function checkDeployment() {
                        let allMet = true;
                        
                        for (let i = 0; i < zones.length; i++) {
                            if (zones[i].current < zones[i].min) {
                                allMet = false;
                                break;
                            }
                        }
                        
                        if (allMet) {
                            completeBtn.classList.remove('hidden');
                        }
                    }
                }
            }
            
            // 3. 巾帼风云：历史映照
            function initializeHistoricalReflection() {
                let completedScenarios = 0;
                const totalScenarios = 3;
                
                // 军粮短缺情境
                document.getElementById('submit-scenario-food').addEventListener('click', function() {
                    const selected = document.querySelector('input[name="scenario-food"]:checked');
                    if (!selected) {
                        alert('请选择一个选项！');
                        return;
                    }
                    
                    const resultContainer = document.getElementById('reflection-food');
                    resultContainer.classList.remove('hidden');
                    
                    // 根据选择显示不同结果
                    if (selected.value === 'A') {
                        resultContainer.innerHTML = `
                            <h5 class="font-bold mb-1">你的选择与秦良玉的风格相似</h5>
                            <p class="text-sm">秦良玉在率领白杆兵时，常与士兵同甘共苦，因此得到部下的忠心拥护。领导者以身作则，对士气有极大提升。</p>
                        `;
                        gameState.updateEmotion('courage', 10);
                        gameState.updateEmotion('determination', 5);
                    } else if (selected.value === 'B') {
                        resultContainer.innerHTML = `
                            <h5 class="font-bold mb-1">你的选择与穆桂英的风格相似</h5>
                            <p class="text-sm">穆桂英擅长随机应变，在困境中寻找解决方案。在资源短缺的情况下，开拓思路寻找替代方案是军事领导人的重要能力。</p>
                        `;
                        gameState.updateEmotion('determination', 10);
                        gameState.updateEmotion('courage', 5);
                    } else if (selected.value === 'C') {
                        resultContainer.innerHTML = `
                            <h5 class="font-bold mb-1">你的选择与梁红玉的风格相似</h5>
                            <p class="text-sm">梁红玉善于鼓舞士气，在艰难时刻激发士兵斗志。精神力量有时比物质补给更能支撑军队度过难关。</p>
                        `;
                        gameState.updateEmotion('courage', 15);
                    }
                    
                    // 显示下一个情境
                    document.getElementById('scenario-command').classList.remove('hidden');
                    this.disabled = true;
                    
                    // 更新完成情境计数
                    completedScenarios++;
                });
                
                // 指挥危机情境
                document.getElementById('submit-scenario-command').addEventListener('click', function() {
                    const selected = document.querySelector('input[name="scenario-command"]:checked');
                    if (!selected) {
                        alert('请选择一个选项！');
                        return;
                    }
                    
                    const resultContainer = document.getElementById('reflection-command');
                    resultContainer.classList.remove('hidden');
                    
                    // 根据选择显示不同结果
                    if (selected.value === 'A') {
                        resultContainer.innerHTML = `
                            <h5 class="font-bold mb-1">你的选择展现了忠诚与纪律</h5>
                            <p class="text-sm">秦良玉以对明朝的忠诚著称，即使在困难时期也坚守原则。遵循军令在某些情况下是明智的，特别是当战局复杂，个人判断可能有限时。</p>
                        `;
                        gameState.updateEmotion('determination', 15);
                    } else if (selected.value === 'B') {
                        resultContainer.innerHTML = `
                            <h5 class="font-bold mb-1">你的选择体现了穆桂英的指挥风格</h5>
                            <p class="text-sm">穆桂英以灵活多变的战术著称，能根据实际情况调整战略。在战场上，过于刻板地遵循计划可能导致失败，临机应变是优秀指挥官的特质。</p>
                        `;
                        gameState.updateEmotion('courage', 10);
                        gameState.updateEmotion('determination', 10);
                    } else if (selected.value === 'C') {
                        resultContainer.innerHTML = `
                            <h5 class="font-bold mb-1">你的选择展现了战略眼光</h5>
                            <p class="text-sm">懂得在不利局势下及时撤退保存实力，是军事领导人的重要素质。木兰在《木兰诗》中的成功，部分源于她懂得何时进取，何时守成。</p>
                        `;
                        gameState.updateEmotion('fear', -15);
                        gameState.updateEmotion('determination', 5);
                    }
                    
                    // 显示下一个情境
                    document.getElementById('scenario-identity').classList.remove('hidden');
                    this.disabled = true;
                    
                    // 更新完成情境计数
                    completedScenarios++;
                });
                
                // 身份困境情境
                document.getElementById('submit-scenario-identity').addEventListener('click', function() {
                    const selected = document.querySelector('input[name="scenario-identity"]:checked');
                    if (!selected) {
                        alert('请选择一个选项！');
                        return;
                    }
                    
                    const resultContainer = document.getElementById('reflection-identity');
                    resultContainer.classList.remove('hidden');
                    
                    // 根据选择显示不同结果
                    if (selected.value === 'A') {
                        resultContainer.innerHTML = `
                            <h5 class="font-bold mb-1">你选择了自我保护</h5>
                            <p class="text-sm">木兰为完成使命而隐藏身份十二年，这种选择虽有自保的成分，但也是为了能够继续执行替父从军的使命。在某些情况下，保守秘密也是一种责任。</p>
                        `;
                        gameState.updateEmotion('fear', -5);
                        gameState.updateEmotion('determination', 10);
                    } else if (selected.value === 'B') {
                        resultContainer.innerHTML = `
                            <h5 class="font-bold mb-1">你选择了平衡之道</h5>
                            <p class="text-sm">在个人秘密和救助他人之间寻找平衡，体现了木兰的智慧。历史上的女英雄们常常需要在社会限制和个人使命之间寻找妥协之道。</p>
                        `;
                        gameState.updateEmotion('courage', 10);
                        gameState.updateEmotion('determination', 5);
                    } else if (selected.value === 'C') {
                        resultContainer.innerHTML = `
                            <h5 class="font-bold mb-1">你选择了无私奉献</h5>
                            <p class="text-sm">这种无条件救助他人的选择，体现了女英雄们常有的无私精神。梁红玉、秦良玉等人都曾在关键时刻不顾个人安危，展现了超越自我的勇气。</p>
                        `;
                        gameState.updateEmotion('courage', 15);
                        gameState.updateEmotion('fear', 10);
                    }
                    
                    this.disabled = true;
                    
                    // 更新完成情境计数
                    completedScenarios++;
                    
                    // 所有情境都完成后
                    if (completedScenarios >= totalScenarios) {
                        setTimeout(() => {
                            completeLevel4();
                        }, 1000);
                    }
                });
            }
            
            // 关卡完成函数
            function completeLevel4() {
                // 更新情感变化显示
                const emotionChanges = document.getElementById('emotion-changes-4');
                emotionChanges.innerHTML = `
                    <div>勇气 +${25}%</div>
                    <div>决心 +${25}%</div>
                    <div>恐惧 ${-15}%</div>
                    <div>思乡 ${-5}%</div>
                `;
                
                // 显示关卡完成信息
                document.getElementById('level-completion-4').classList.remove('hidden');
                
                // 标记关卡完成
                gameState.completeLevel(4);
            }
        }
        
        // 关卡五：功成名就
        function initializeLevel5() {
            // 1. 最终抉择
            document.getElementById('submit-final-choice').addEventListener('click', function() {
                const selectedChoice = document.querySelector('input[name="final-choice"]:checked');
                if (!selectedChoice) {
                    alert('请做出选择！');
                    return;
                }
                
                // 根据选择更新情感状态
                switch(selectedChoice.value) {
                    case 'A': // 接受官职
                        gameState.updateEmotion('courage', 10);
                        gameState.updateEmotion('homesick', -10);
                        gameState.updateEmotion('determination', 15);
                        gameState.updateEmotion('fear', 20);
                        gameState.ending = 'failure';
                        break;
                    case 'B': // 请求回乡
                        gameState.updateEmotion('courage', 5);
                        gameState.updateEmotion('homesick', 20);
                        gameState.updateEmotion('determination', 10);
                        gameState.updateEmotion('fear', -15);
                        gameState.ending = 'standard';
                        break;
                    case 'C': // 请求特殊恩赐
                        gameState.updateEmotion('courage', 30);
                        gameState.updateEmotion('homesick', 10);
                        gameState.updateEmotion('determination', 25);
                        gameState.updateEmotion('fear', 10);
                        
                        // 隐藏结局条件：勇气和决心都超过90
                        if (gameState.emotions.courage > 90 && gameState.emotions.determination > 90) {
                            gameState.ending = 'hidden';
                        } else {
                            gameState.ending = 'failure';
                        }
                        break;
                    case 'D': // 另辟蹊径
                        gameState.updateEmotion('courage', 15);
                        gameState.updateEmotion('homesick', 5);
                        gameState.updateEmotion('determination', 20);
                        gameState.updateEmotion('fear', 5);
                        gameState.ending = 'standard';
                        break;
                }
                
                // 显示诗歌填空
                document.getElementById('final-poem').classList.remove('hidden');
            });
            
            // 2. 《木兰诗》结尾填空 - 使用改进的交互方式
            const poemBlanks = document.querySelectorAll('#final-poem .blank');
            const wordChoices = document.querySelectorAll('#word-bank-5 .word-choice');
            
            // 为每个空白处添加相同的改进交互方式
            poemBlanks.forEach(blank => {
                // 添加标记，让用户知道这里需要填词
                blank.textContent = "点击填词";
                blank.classList.add('text-gray-400', 'hover:bg-yellow-50');
                
                blank.addEventListener('click', function() {
                    // 高亮当前选中的空白
                    poemBlanks.forEach(b => b.classList.remove('bg-yellow-100'));
                    this.classList.add('bg-yellow-100');
                    
                    // 创建并显示选词弹窗
                    showFinalPoemSelectionPopup(this);
                });
            });
            
            // 创建词语选择弹窗
            function showFinalPoemSelectionPopup(blank) {
                // 移除任何已存在的弹窗
                const existingPopup = document.getElementById('poem-selection-popup');
                if (existingPopup) existingPopup.remove();
                
                // 创建新弹窗
                const popup = document.createElement('div');
                popup.id = 'poem-selection-popup';
                popup.className = 'absolute bg-white dark:bg-gray-700 p-2 rounded-lg shadow-lg z-20 flex flex-wrap gap-1 max-w-xs';
                
                // 计算弹窗位置 - 默认显示在空白下方
                const blankRect = blank.getBoundingClientRect();
                const containerRect = document.getElementById('game-container').getBoundingClientRect();
                
                popup.style.left = `${blankRect.left - containerRect.left}px`;
                popup.style.top = `${blankRect.bottom - containerRect.top + 5}px`;
                
                // 添加词语选项
                wordChoices.forEach(choice => {
                    const wordOption = document.createElement('button');
                    wordOption.className = 'px-2 py-1 bg-amber-200 text-gray-800 rounded hover:bg-amber-300 text-sm';
                    wordOption.textContent = choice.textContent;
                    
                    wordOption.addEventListener('click', function() {
                        blank.textContent = this.textContent;
                        blank.classList.remove('bg-yellow-100', 'text-gray-400');
                        popup.remove();
                    });
                    
                    popup.appendChild(wordOption);
                });
                
                // 添加取消按钮
                const cancelButton = document.createElement('button');
                cancelButton.className = 'px-2 py-1 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 text-sm';
                cancelButton.textContent = '取消';
                cancelButton.addEventListener('click', function() {
                    blank.classList.remove('bg-yellow-100');
                    popup.remove();
                });
                popup.appendChild(cancelButton);
                
                // 添加到容器
                document.getElementById('game-container').appendChild(popup);
                
                // 点击其他地方关闭弹窗
                document.addEventListener('click', function closePopup(e) {
                    if (!popup.contains(e.target) && e.target !== blank) {
                        blank.classList.remove('bg-yellow-100');
                        popup.remove();
                        document.removeEventListener('click', closePopup);
                    }
                });
            }
            
            // 检查诗句填空
            document.getElementById('check-poem').addEventListener('click', function() {
                let correct = 0;
                poemBlanks.forEach(blank => {
                    if (blank.textContent === blank.dataset.answer) {
                        blank.classList.add('bg-green-100');
                        blank.classList.remove('bg-red-100');
                        correct++;
                    } else {
                        blank.classList.add('bg-red-100');
                        blank.classList.remove('bg-green-100');
                    }
                });
                
                const accuracy = (correct / poemBlanks.length) * 100;
                
                if (accuracy >= 70) {
                    alert('诗句填写通过！继续下一环节。');
                    document.getElementById('emotion-matching').classList.remove('hidden');
                    initializeEmotionMatching();
                } else {
                    alert(`正确率: ${accuracy.toFixed(1)}%。需要70%才能通过，请再试一次！`);
                }
            });
            
            // 3. 情感配对
            function initializeEmotionMatching() {
                // 拖拽功能
                const emotionItems = document.querySelectorAll('.emotion-item');
                const verseItems = document.querySelectorAll('.verse-item');
                let draggedItem = null;
                
                emotionItems.forEach(item => {
                    item.addEventListener('dragstart', function() {
                        draggedItem = this;
                        setTimeout(() => this.style.opacity = '0.5', 0);
                    });
                    
                    item.addEventListener('dragend', function() {
                        this.style.opacity = '1';
                    });
                    
                    // 点击选择（替代拖拽）
                    item.addEventListener('click', function() {
                        if (draggedItem) {
                            draggedItem.style.opacity = '1';
                        }
                        draggedItem = this;
                        this.style.opacity = '0.5';
                    });
                });
                
                verseItems.forEach(item => {
                    item.addEventListener('dragover', function(e) {
                        e.preventDefault();
                    });
                    
                    item.addEventListener('drop', function(e) {
                        e.preventDefault();
                        handleDrop(this);
                    });
                    
                    // 点击放置（替代拖放）
                    item.addEventListener('click', function() {
                        if (draggedItem) {
                            handleDrop(this);
                            draggedItem = null;
                        }
                    });
                });
                
                function handleDrop(verseItem) {
                    // 清除已有的配对
                    verseItems.forEach(verse => {
                        const existing = verse.querySelector('.dropped-emotion');
                        if (existing && existing.dataset.emotion === draggedItem.dataset.emotion) {
                            existing.remove();
                            verse.querySelector('.dropzone').classList.remove('hidden');
                            verse.querySelector('.verse').classList.add('hidden');
                        }
                    });
                    
                    // 添加新配对
                    const dropzone = verseItem.querySelector('.dropzone');
                    const verse = verseItem.querySelector('.verse');
                    
                    dropzone.classList.add('hidden');
                    verse.classList.remove('hidden');
                    
                    const emotionClone = draggedItem.cloneNode(true);
                    emotionClone.classList.add('dropped-emotion');
                    emotionClone.classList.add('mt-2');
                    emotionClone.setAttribute('draggable', 'false');
                    verseItem.appendChild(emotionClone);
                }
                
                // 检查配对
                document.getElementById('check-emotion-matching').addEventListener('click', function() {
                    const correctMapping = {
                        'A': 'A', // 闻军令时的忧虑 - 不闻机杼声，惟闻女叹息。
                        'B': 'B', // 决定从军时的决心 - 万里赴戎机，关山度若飞。
                        'C': 'C', // 战场上的勇敢 - 旌旗十万斩阎罗。
                        'D': 'D', // 凯旋时的喜悦 - 归来见天子，天子坐明堂。
                        'E': 'E'  // 归家时的释然 - 脱我战时袍，著我旧时裳。
                    };
                    
                    let correct = 0;
                    let total = 0;
                    
                    verseItems.forEach(verse => {
                        const droppedEmotion = verse.querySelector('.dropped-emotion');
                        if (droppedEmotion) {
                            total++;
                            const verseId = verse.dataset.verse;
                            const emotionId = droppedEmotion.dataset.emotion;
                            
                            if (correctMapping[emotionId] === verseId) {
                                verse.classList.add('border-green-500');
                                correct++;
                            } else {
                                verse.classList.add('border-red-500');
                            }
                        }
                    });
                    
                    if (total < Object.keys(correctMapping).length) {
                        alert(`请完成所有配对！已配对 ${total}/${Object.keys(correctMapping).length} 项。`);
                        return;
                    }
                    
                    const accuracy = (correct / total) * 100;
                    
                    if (accuracy >= 60) {
                        alert(`正确率: ${accuracy.toFixed(1)}%。配对成功！`);
                        completeLevel5();
                    } else {
                        alert(`正确率: ${accuracy.toFixed(1)}%。需要60%才能通过，请再试一次！`);
                        
                        // 重置配对
                        verseItems.forEach(verse => {
                            verse.classList.remove('border-green-500', 'border-red-500');
                            const droppedEmotion = verse.querySelector('.dropped-emotion');
                            if (droppedEmotion) {
                                droppedEmotion.remove();
                            }
                            verse.querySelector('.dropzone').classList.remove('hidden');
                            verse.querySelector('.verse').classList.add('hidden');
                        });
                    }
                });
            }
            
            // 关卡完成
            function completeLevel5() {
                // 更新最终情感状态显示
                document.getElementById('final-courage').textContent = `${gameState.emotions.courage}%`;
                document.getElementById('final-homesick').textContent = `${gameState.emotions.homesick}%`;
                document.getElementById('final-determination').textContent = `${gameState.emotions.determination}%`;
                document.getElementById('final-fear').textContent = `${gameState.emotions.fear}%`;
                
                // 显示关卡完成信息
                document.getElementById('level-completion-5').classList.remove('hidden');
                
                // 标记关卡完成
                gameState.completeLevel(5);
            }
            
            // 查看结局按钮
            document.getElementById('view-ending').addEventListener('click', function() {
                hideAllScreens();
                document.getElementById('ending-screen').classList.remove('hidden');
                
                // 根据结局类型显示对应结局
                document.getElementById('standard-ending').classList.toggle('hidden', gameState.ending !== 'standard');
                document.getElementById('failure-ending').classList.toggle('hidden', gameState.ending !== 'failure');
                document.getElementById('hidden-ending').classList.toggle('hidden', gameState.ending !== 'hidden');
            });
        }
    </script>
</body>
</html>